<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="app.labs.dao.ProgressDao">

    <resultMap id="progressResultMap" type="app.labs.model.ProgressDTO">
        <id property="orderId" column="order_id"/>
        <result property="orderNum" column="order_num"/>
        <result property="orderTime" column="order_time"/>
        <result property="destination" column="destination"/>
        <result property="palletId" column="pallet_id"/>
        <result property="boxState" column="box_state"/>
        <result property="progressState" column="progress_state"/>
        <result property="productName" column="name"/>
        <result property="productCategory" column="category"/>
        <result property="boxSpec" column="boxSpec" javaType="java.lang.Integer"/>  <!-- ✅ 수정 -->
    </resultMap>

    <select id="getFilteredProgressList" resultMap="progressResultMap">
        SELECT o.order_id, o.order_num, o.order_time, o.destination, o.pallet_id, 
               o.box_state, o.progress_state, p.name, p.category, p.spec AS boxSpec  <!-- ✅ p.spec을 boxSpec으로 명확히 설정 -->
        FROM `order` o
        LEFT JOIN `product` p ON o.product_id = p.product_id
        WHERE 1=1
        <if test="date != null and date != ''">
            AND DATE(o.order_time) = #{date}
        </if>
        <if test="camp != null and camp != ''">
            AND o.destination = #{camp}
        </if>
        <if test="orderNum != null and orderNum != ''">
            AND o.order_num = #{orderNum}
        </if>
        <if test="boxSpec != null">
            AND p.spec = #{boxSpec}
        </if>
        <if test="boxState != null">
            AND o.box_state = #{boxState}
        </if>
        <if test="progressState != null">
            AND o.progress_state = #{progressState}
        </if>
        ORDER BY o.order_time ASC
        LIMIT #{pageSize} OFFSET #{offset}
    </select>


    <!-- 필터링된 진행 상태 개수 조회 -->
	<select id="getTotalFilteredRecords" resultType="int">
	    SELECT COUNT(*)
	    FROM `order` o
	    LEFT JOIN `product` p ON o.product_id = p.product_id
	    WHERE 1=1
	    <if test="date != null and date != ''">
	        AND DATE(o.order_time) = #{date}
	    </if>
	    <if test="camp != null and camp != ''">
	        AND o.destination = #{camp}
	    </if>
	    <if test="orderNum != null and orderNum != ''">
	        AND o.order_num = #{orderNum}
	    </if>
	    <if test="boxSpec != null">  <!-- ✅ 수정: box_spec을 product 테이블에서 가져오도록 변경 -->
	        AND p.spec = #{boxSpec}
	    </if>
	    <if test="boxState != null">
	        AND o.box_state = #{boxState}
	    </if>
	    <if test="progressState != null">
	        AND o.progress_state = #{progressState}
	    </if>
	</select>
	
	<update id="updateOrdersProgress">
	    UPDATE `order`
	    SET 
	        progress_state = #{progressState}, 
	        image_number = 
	        <if test="imageNumber != null">
	            #{imageNumber}
	        </if>
	        <if test="imageNumber == null">
	            NULL
	        </if>
	    WHERE order_id IN 
	    <foreach item="orderId" collection="orderIds" open="(" separator="," close=")">
	        #{orderId}
	    </foreach>
	</update>

	
</mapper>
