<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorator="~{/thymeleaf/html/common/default_layout}">


<head>
<th:block layout:fragment="css">
	<link rel="stylesheet" th:href="@{/css/admin/admin.css}" />
	<link rel="stylesheet" th:href="@{/css/admin/admin_product.css}">

	<!-- 제이쿼리 -->
    <script th:src="@{https://code.jquery.com/jquery-3.3.1.min.js}"></script>

	<!-- 부트스트랩 -->
    <link 
        th:href="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css}" 
        rel="stylesheet" 
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" 
        crossorigin="anonymous">
    <script 
        th:src="@{https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js}" 
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" 
        crossorigin="anonymous"></script>

	<style>
/* 드롭다운 버튼 테두리 제거 */
.btn-reveal-trigger .btn-reveal {
	border: none !important;
	box-shadow: none !important;
	background: transparent !important;
}

.btn-reveal-trigger .btn-reveal:hover, .btn-reveal-trigger .btn-reveal:focus,
	.btn-reveal-trigger .btn-reveal:active {
	border: none !important;
	box-shadow: none !important;
	background: transparent !important;
}

/* 드롭다운 화살표 제거 */
.dropdown-caret-none::after {
	display: none !important;
}
</style>
</head>

<body>
<th:block layout:fragment="wrapper">
	<div class="outside-container">
		<div class="main-container">
			<div th:replace="~{thymeleaf/html/common/include::profile}"></div>
			<div th:replace="~{thymeleaf/html/common/include::sidebar}"></div>


			<!-- 상단 버튼 -->
			<div class="product-actions">
				<button type="button" class="btn btn-primary" id="addBtn">
					Add Product</button>
			</div>
				<!-- 상단 버튼 -->
				<div class="product-actions">
					<button type="button" class="btn btn-primary" id="addBtn">
						Add Product</button>
				</div>
				<div layout:fragment="content" class="main-content">
					<!-- 제품 목록 테이블 -->
					<div class="table-container">

						<div class="search-filter-container">
							<!-- 검색 폼 -->
							<form class="search-form" style="display: inline-block;">
								<input type="text" name="name" placeholder="제품명 검색" />
								<button type="submit">검색</button>
							</form>

							<!-- 필터 -->
							<label for="categoryFilter">Category:</label> <select
								id="categoryFilter">
								<option value="전체">전체</option>
								<option value="잡화류" th:selected="${selectedCategory eq '잡화류'}">잡화류</option>
								<option value="전자제품류"
									th:selected="${selectedCategory eq '전자제품류'}">전자제품류</option>
								<option value="가공식품" th:selected="${selectedCategory eq '가공식품'}">가공식품</option>
								<option value="제과류" th:selected="${selectedCategory eq '제과류'}">제과류</option>
								<option value="음료" th:selected="${selectedCategory eq '음료'}">음료</option>
								<option value="의류" th:selected="${selectedCategory eq '의류'}">의류</option>
								<option value="세정용 화장품류"
									th:selected="${selectedCategory eq '세정용 화장품류'}">세정용
									화장품류</option>
								<option value="그 밖의 화장품류"
									th:selected="${selectedCategory eq '그 밖의 화장품류'}">그 밖의
									화장품류</option>
								<option value="의약외품류"
									th:selected="${selectedCategory eq '의약외품류'}">의약외품류</option>
								<option value="세제류" th:selected="${selectedCategory eq '세제류'}">세제류</option>
								<option value="건강기능식품"
									th:selected="${selectedCategory eq '건강기능식품'}">건강기능식품</option>
								<!-- 기존 카테고리 옵션들 -->
							</select> <label for="fragileFilter">Fragile:</label> <select
								id="fragileFilter">
								<option value="전체">전체</option>
								<option value="true">Yes</option>
								<option value="false">No</option>
							</select>
						</div>

						<table class="product-table" id="productTable">

							<h1>Product List</h1>

							<thead>
								<tr>
									<th class="d-none"></th>
									<th>NO.</th>
									<th>Name</th>
									<th>Width</th>
									<th>Depth</th>
									<th>Height</th>
									<th>Weight</th>
									<th>Category</th>
									<th>Fragile</th>
								</tr>
							</thead>


							<tbody id="listBody">
								<tr th:each="product, iterStat : ${products}">
									<td class="productId d-none" th:text="${product.productId}"></td>
									<td class="index" th:text="${iterStat.index + 1}"></td>
									<!-- ID 대신 1부터 시작하는 인덱스 -->
									<td class="name" th:text="${product.name}"></td>
									<td class="width" th:text="${product.width}"></td>
									<td class="depth" th:text="${product.depth}"></td>
									<td class="height" th:text="${product.height}"></td>
									<td class="weight" th:text="${product.weight}"></td>
									<td class="category" th:text="${product.category}"></td>
									<td class="isFragile"
										th:text="${product.isFragile != null ? (product.isFragile ? 'Yes' : 'No') : 'No'}"></td>
								</tr>

								<tr th:if="${products.size() == 0}">
									<td colspan="9" style="text-align: center;">No products
										found.</td>
								</tr>

							</tbody>

						</table>
					</div>
					<!--상단 컨트롤 바 종료 부분-->

					<div class="right-controls">

						
					</div>
				</div>



				<!-- 제품 목록 테이블 -->
				<div class="table-container">
					<table class="product-table" id="productTable">

						<h1>Product List</h1>

						<thead>
							<tr>
								<th class="d-none"></th>
								<th>NO.</th>
								<th>Name</th>
								<th>Width</th>
								<th>Depth</th>
								<th>Height</th>
								<th>Weight</th>
								<th>Category</th>
								<th>Fragile</th>
							</tr>
						</thead>


						<tbody id="listBody">
							<tr th:each="product, iterStat : ${products}">
								<td class="productId d-none" th:text="${product.productId}"></td>
								<td class="index" th:text="${iterStat.index + 1}"></td>
								<!-- ID 대신 1부터 시작하는 인덱스 -->
								<td class="name" th:text="${product.name}"></td>
								<td class="width" th:text="${product.width}"></td>
								<td class="depth" th:text="${product.depth}"></td>
								<td class="height" th:text="${product.height}"></td>
								<td class="weight" th:text="${product.weight}"></td>
								<td class="category" th:text="${product.category}"></td>
								<td class="fragile"
									th:text="${product.fragile != null ? (product.fragile ? 'Yes' : 'No') : 'No'}"></td>

							</tr>

							<tr th:if="${products.size() == 0}">
								<td colspan="9" style="text-align: center;">No products
									found.</td>
							</tr>

						</tbody>

					</table>
				</div>

				<!-- 페이지네이션 -->
				<div class="pagination">
					<button id="prevGroup">«</button>
					<span id="pageNumbers"></span>
					<button id="nextGroup">»</button>
				</div>



			</div>
		</div>
	</div>
</th:block>

	<!-- 물품 추가, 수정 시 뜰 모달창 -->
	<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog"
		aria-labelledby="exampleModalLabel">
		<div class="modal-dialog modal-full" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h1 class="modal-title fs-5" id="exampleModalLabel">Add
						Product</h1>
					<button type="button" class="btn-close" data-bs-dismiss="modal"
						aria-label="Close">
						<span class="visually-hidden">Close</span>
					</button>
				</div>
				<div class="modal-body">
					<form th:action="@{/admin/product/add}" method="post"
						id="productAdd">
						<input id="modalIndex" type="hidden" name="index" /> 
							Name: <input id="modalName" type="text" name="name" required /><br />
							Width: <input id="modalWidth" type="number" name="width" required /><br />
							Depth: <input id="modalDepth" type="number" name="depth" required /><br />
							Height: <input id="modalHeight" type="number" name="height" required /><br /> 
							Weight: <input id="modalWeight" type="number"name="weight" required /><br /> 
							Category: 
							<select id="modalCategory" name="category" required>
								<option value="">선택하세요</option>
								<option value="잡화류">잡화류</option>
								<option value="전자제품류">전자제품류</option>
								<option value="가공식품">가공식품</option>
								<option value="제과류">제과류</option>
								<option value="음료">음료</option>
								<option value="의류">의류</option>
								<option value="세정용 화장품류">세정용 화장품류</option>
								<option value="그 밖의 화장품류">그 밖의 화장품류</option>
								<option value="의약외품류">의약외품류</option>
								<option value="세제류">세제류</option>
								<option value="건강기능식품">건강기능식품</option>
							</select><br /> 
							Fragile: <input type="checkbox" name="isFragile" id="fragileCheckbox" value="1" /> 
									 <input type="hidden"name="isFragileHidden" id="isFragileHidden" value="0" />>
					</form>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-bs-dismiss="modal">Close</button>
					<button type="button" class="btn btn-primary" id="submit-btn">Submit</button>
				</div>
			</div>
		</div>
	</div>

	<script>
		// 페이지네이션 관련 전역 변수
		let currentPage = 1;
		let rowsPerPage = 20;
		let pageGroupSize = 10;
		let totalPages = 1;
		let currentProducts = []; // 전체 제품 데이터 저장용

		// 페이지 로드 시 실행
		$(document).ready(function() {
			initializeEventHandlers();
			initializePaginationButtons(); // 페이지네이션 버튼 초기화 추가
			searchProducts();
		});
		

		// 모든 이벤트 핸들러 초기화
		function initializeEventHandlers() {
			// Add Product 버튼 이벤트
			$("#addBtn").on("click", function() {
				clearModalInputs();
				$("#exampleModalLabel").text("Add Product");
				$("#exampleModal").modal('show');
			});

			// Submit 버튼 이벤트
			$("#submit-btn").on("click", handleSubmit);

			// 검색 폼 제출 이벤트
			$(".search-form").on("submit", function(e) {
				e.preventDefault();
				searchProducts();
			});

			// 필터 변경 이벤트
			$("#categoryFilter, #fragileFilter").on("change", function() {
				searchProducts();
			});
		}

		// 통합 검색 함수
		function searchProducts() {
			let searchQuery = $(".search-form input[name='name']").val().trim();
			let filterInfo = {
				name: searchQuery,
				filter: $("#categoryFilter").val()?.trim() || "전체",
				isFragile: $("#fragileFilter").val()?.trim() || "전체"
			};

			$.ajax({
				url: "/admin/product/search",
				type: "GET",
				data: filterInfo,
				success: function(data) {
					updateProductList(data);
				},
				error: function(xhr, status, error) {
					console.error("검색 오류:", error);
					alert("검색 중 오류가 발생했습니다.");
				}
			});
		}

		// 제품 목록 업데이트
		function updateProductList(products) {
			currentProducts = products;
			// 최소 1페이지는 항상 존재하도록 설정
			totalPages = Math.max(1, Math.ceil(products.length / rowsPerPage));
			currentPage = 1; // 검색/필터링 시 첫 페이지로 초기화
			displayCurrentPage();
			updatePagination();
		}

		// 현재 페이지 표시
		function displayCurrentPage() {
			let startIndex = (currentPage - 1) * rowsPerPage;
			let endIndex = Math.min(startIndex + rowsPerPage, currentProducts.length);
			let currentPageProducts = currentProducts.slice(startIndex, endIndex);
			
			let html = '';
			if (currentPageProducts.length === 0) {
				html = '<tr><td colspan="9" class="text-center">검색 결과가 없습니다.</td></tr>';
			} else {
				currentPageProducts.forEach((product, index) => {
					// isFragile 값을 명시적으로 확인
					let isFragileValue = product.fragile === true || product.fragile === 1;
					
					html += `<tr>
						<td class="productId d-none">${product.productId}</td>
						<td class="index">${startIndex + index + 1}</td>
						<td class="name">${product.name}</td>
						<td class="width">${product.width}</td>
						<td class="depth">${product.depth}</td>
						<td class="height">${product.height}</td>
						<td class="weight">${product.weight}</td>
						<td class="category">${product.category}</td>
						<td class="isFragile">${isFragileValue ? 'Yes' : 'No'}</td>
						<td>
							<div class="btn-reveal-trigger position-static">
								<button class="btn btn-sm dropdown-toggle dropdown-caret-none transition-none btn-reveal" type="button" data-bs-toggle="dropdown" data-boundary="window" aria-haspopup="true" aria-expanded="false" data-bs-reference="parent">
									•••
								</button>
								<div class="dropdown-menu py-2">
									<a class="dropdown-item editBtn" onclick="handleEdit(this)">Edit</a>
									<a class="dropdown-item deleteBtn">Delete</a>
								</div>
							</div>
						</td>
						
					</tr>`;
				});
			}
			
			$("#listBody").html(html);
			bindDeleteButtons();
		}

		// 페이지네이션 UI 업데이트
		function updatePagination() {
			let pageNumbersElement = $("#pageNumbers");
			pageNumbersElement.empty();
			
			// 검색 결과가 없을 때도 페이지네이션 표시
			if (currentProducts.length === 0) {
				$("#prevGroup, #nextGroup").hide();
				let btn = $("<button>")
					.text(1)
					.addClass("btn mx-1 btn-purple btn-purple-active")
					.prop("disabled", true);
				pageNumbersElement.append(btn);
				return;
			}
			
			$("#prevGroup, #nextGroup").show();
			
			let startPage = Math.floor((currentPage - 1) / pageGroupSize) * pageGroupSize + 1;
			let endPage = Math.min(startPage + pageGroupSize - 1, totalPages);
			
			// 최소 1페이지는 항상 표시
			endPage = Math.max(1, endPage);
			
			// 이전 그룹 버튼
			$("#prevGroup")
				.prop("disabled", startPage <= 1)
				.removeClass("btn-secondary")
				.addClass("btn-purple");
			
			// 페이지 번호 버튼들
			for (let i = startPage; i <= endPage; i++) {
				let btn = $("<button>")
					.text(i)
					.addClass("btn mx-1 btn-purple")
					.on("click", function() {
						if (currentPage !== i) {
							currentPage = i;
							displayCurrentPage();
							updatePagination();
						}
					});
				
				if (i === currentPage) {
					btn.removeClass("btn-purple").addClass("btn-purple-active");
				}
				
				pageNumbersElement.append(btn);
			}
			
			// 다음 그룹 버튼
			$("#nextGroup")
				.prop("disabled", endPage >= totalPages)
				.removeClass("btn-secondary")
				.addClass("btn-purple");
		}

		// 이전/다음 그룹 버튼 이벤트 핸들러
		function initializePaginationButtons() {
			$("#prevGroup").on("click", function() {
				if (!$(this).prop("disabled")) {
					currentPage = Math.max(1, currentPage - pageGroupSize);
					displayCurrentPage();
					updatePagination();
				}
			});

			$("#nextGroup").on("click", function() {
				if (!$(this).prop("disabled")) {
					currentPage = Math.min(totalPages, currentPage + pageGroupSize);
					displayCurrentPage();
					updatePagination();
				}
			});
		}

		// Delete 버튼 이벤트 바인딩
		function bindDeleteButtons() {
			$(".deleteBtn").off("click").on("click", function() {
				let productId = $(this).closest("tr").find(".productId").text().trim();
				handleDelete(productId);
			});
		}

		// Delete 처리
		function handleDelete(productId) {
			if (confirm("정말로 이 제품을 삭제하시겠습니까?")) {
				$.ajax({
					url: `/admin/product/delete/${productId}`,
					type: "GET",
					success: function() {
						searchProducts(); // 삭제 후 목록 새로고침
					},
					error: function() {
						alert("제품 삭제 중 오류가 발생했습니다.");
					}
				});
			}
		}

		// Edit 처리
		function handleEdit(button) {
			let row = $(button).closest("tr");
			
			// 모달 제목 변경
			$("#exampleModalLabel").text("Edit Product");
			
			// 값 채우기
			$("#modalIndex").val(row.find(".productId").text().trim());
			$("#modalName").val(row.find(".name").text().trim());
			$("#modalWidth").val(row.find(".width").text().trim());
			$("#modalDepth").val(row.find(".depth").text().trim());
			$("#modalHeight").val(row.find(".height").text().trim());
			$("#modalWeight").val(row.find(".weight").text().trim());
			$("#modalCategory").val(row.find(".category").text().trim());
			
			// Fragile 상태 설정
			let isFragileText = row.find(".isFragile").text().trim();
			$("#fragileCheckbox").prop("checked", isFragileText === "Yes");
			
		    $("#exampleModal").removeAttr("aria-hidden");

		    // 모달 열기
		    $("#exampleModal").modal("show");
		    
		 	// 🔥 Bootstrap의 `shown.bs.modal` 이벤트를 사용해 포커스 조정
		    $("#exampleModal").on("shown.bs.modal", function () {
		        $("#modalName").trigger("focus"); // 첫 번째 입력 필드에 포커스
		    });
		 	
		    // 🔥 추가: 모달이 닫힐 때 이벤트 정리
		    $("#exampleModal").on("hidden.bs.modal", function () {
		        $("#exampleModal").off("shown.bs.modal hidden.bs.modal"); // 이벤트 정리
		    });
			
		}

		// Submit 처리
		function handleSubmit() {
			let product = {
				productId: $("#modalIndex").val().trim(),
				name: $("#modalName").val().trim(),
				width: $("#modalWidth").val().trim(),
				depth: $("#modalDepth").val().trim(),
				height: $("#modalHeight").val().trim(),
				weight: $("#modalWeight").val().trim(),
				category: $("#modalCategory").val().trim(),
				isFragile: $("#fragileCheckbox").is(":checked") ? 1 : 0
				
			};

			if (!validateProduct(product)) {
				alert("모든 필드를 입력해주세요.");
				return;
			}

			if (product.productId) {
				updateProduct(product);
			} else {
				addProduct(product);
			}
		}

		// 제품 추가
		function addProduct(product) {
			$.ajax({
				url: "/admin/product/add",
				type: "POST",
				data: product,
				success: function() {
					$("#exampleModal").modal("hide");
					searchProducts();
				},
				error: function() {
					alert("제품 추가 중 오류가 발생했습니다.");
				}
			});
		}

		// 제품 수정
		function updateProduct(product) {
			$.ajax({
				url: "/admin/product/update",
				type: "POST",
				data: product,
				success: function() {
					$("#exampleModal").modal("hide");
					searchProducts();
				},
				error: function() {
					alert("제품 수정 중 오류가 발생했습니다.");
				}
			});
		}

		// 입력값 검증
		function validateProduct(product) {
			return product.name && 
				   product.width && 
				   product.depth && 
				   product.height && 
				   product.weight && 
				   product.category;
		}

		// 모달 입력 필드 초기화
		function clearModalInputs() {
			$("#modalIndex").val("");
			$("#modalName").val("");
			$("#modalWidth").val("");
			$("#modalDepth").val("");
			$("#modalHeight").val("");
			$("#modalWeight").val("");
			$("#modalCategory").val("");
			$("#fragileCheckbox").prop("checked", false);
		}

		// 모달 관련 JavaScript 수정
		$('#exampleModal').on('show.bs.modal', function () {
			// 모달이 열릴 때 aria-hidden 속성 제거
			$(this).removeAttr('aria-hidden');
		});

		$('#exampleModal').on('shown.bs.modal', function () {
			// 모달이 완전히 열린 후 첫 번째 입력 필드에 포커스
			$('#modalName').trigger('focus');
		});

		$('#exampleModal').on('hidden.bs.modal', function () {
			// 모달이 닫힐 때 초기화
			clearModalInputs();
			$(this).removeAttr('aria-hidden');
		});
	</script>


	<!-- 페이징 기능 스크립트 -->
	<script>
		document.addEventListener("DOMContentLoaded",
			function() {
				var currentPage = 1;
				var rowsPerPage = 10; // 한 페이지당 표시할 행 수
				var pageGroupSize = 10; // 페이지 번호 그룹 크기
	
				var table = document.getElementById("productTable");
				var tbody = table.querySelector("tbody");
				var rows = Array.from(tbody
						.getElementsByTagName("tr"));
				var totalPages = Math.ceil(rows.length / rowsPerPage);
				
				function updateTable() {
					rows.forEach(function(row) {
						row.style.display = "none";
					});
					var startIndex = (currentPage - 1)
							* rowsPerPage;
					var endIndex = Math.min(startIndex
							+ rowsPerPage, rows.length);
					for (var i = startIndex; i < endIndex; i++) {
						rows[i].style.display = "";
					}
				}
	
				function updatePagination() {
					var pageNumbersElement = document
							.getElementById("pageNumbers");
					pageNumbersElement.innerHTML = "";
					var startPage = Math.floor((currentPage - 1)
							/ pageGroupSize)
							* pageGroupSize + 1;
					var endPage = Math.min(startPage
							+ pageGroupSize - 1, totalPages);
					for (var i = startPage; i <= endPage; i++) {
						var btn = document.createElement("button");
						btn.innerText = i;
						if (i === currentPage) {
							btn.classList.add("active");
						}
						btn.addEventListener("click", (function(
								page) {
							return function() {
								currentPage = page;
								updateTable();
								updatePagination();
							};
						})(i));
						pageNumbersElement.appendChild(btn);
					}
				}
	
				// < 페이지 이동 버튼 클릭시 이벤트
				document
						.getElementById("prevGroup")
						.addEventListener(
								"click",
								function() {
									var startPage = Math
											.floor((currentPage - 1)
													/ pageGroupSize)
											* pageGroupSize + 1;
									if (startPage > 1) {
										currentPage = startPage - 1;
										updateTable();
										updatePagination();
									}
								});
				
				// > 페이지 이동 버튼 클릭시 이벤트
				document
						.getElementById("nextGroup")
						.addEventListener(
								"click",
								function() {
									var startPage = Math
											.floor((currentPage - 1)
													/ pageGroupSize)
											* pageGroupSize + 1;
									var endPage = Math
											.min(startPage
													+ pageGroupSize
													- 1, totalPages);
									if (endPage < totalPages) {
										currentPage = endPage + 1;
										updateTable();
										updatePagination();
									}
								});		
				
				updateTable();
				updatePagination();
			});
	</script>
</body>
</html>
