<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="~{/thymeleaf/html/common/default_layout}">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/admin/admin.css}" />
    </th:block>
</head>

<body>
<th:block layout:fragment="wrapper">
    <div class="outside-container">
        <div class="main-container">
            <div th:replace="~{thymeleaf/html/common/include::profile}"></div>
            <div th:replace="~{thymeleaf/html/common/include::sidebar}"></div>
            <div layout:fragment="content" class="main-content">

                <!-- ë‚ ì§œ, ìº í”„, ì£¼ë¬¸ë²ˆí˜¸ í•„í„° í•œ ì¤„ ì •ë ¬ -->
                <div class="filter-container">
                    <label for="dateFilter">ë‚ ì§œ:</label>
                    <input type="date" id="dateFilter"/>

                    <label for="campFilter">ìº í”„:</label>
                    <select id="campFilter">
                        <option value="">ì „ì²´</option>
                        <option value="ì„œì´ˆ ìº í”„">ì„œì´ˆ ìº í”„</option>
                        <option value="ê°•ë‚¨ ìº í”„">ê°•ë‚¨ ìº í”„</option>
                        <option value="ê°•ì„œ ìº í”„">ê°•ì„œ ìº í”„</option>
                        <option value="ì¤‘êµ¬ ìº í”„">ì¤‘êµ¬ ìº í”„</option>
                        <option value="ì„±ë™ ìº í”„">ì„±ë™ ìº í”„</option>
                    </select>
                    
                    <button id="filterBtn">ì¡°íšŒ</button>

                    <!-- ì£¼ë¬¸ë²ˆí˜¸ ê²€ìƒ‰ ì¶”ê°€ -->
                    <label for="orderNumSearch">ì£¼ë¬¸ë²ˆí˜¸:</label>
                    <input type="text" id="orderNumSearch" placeholder="ì£¼ë¬¸ë²ˆí˜¸ ì…ë ¥" />
                    <button id="searchOrderBtn">ê²€ìƒ‰</button>

                </div>

                <!-- ì£¼ë¬¸ ìƒì„± & ì—‘ì…€ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ -->
                <div class="order-actions">
                    <button id="generateOrderBtn">ì£¼ë¬¸ ìƒì„±</button>
                    <button id="downloadExcelBtn">ì—‘ì…€ ë‹¤ìš´ë¡œë“œ</button>
                </div>

                <!-- ì£¼ë¬¸ ëª©ë¡ í…Œì´ë¸” -->
                <div class="table-container">
                    <table class="order-table">
                        <thead>
                            <tr>
                                <th>ì£¼ë¬¸ ID</th>
                                <th>ì£¼ë¬¸ ë²ˆí˜¸</th>
                                <th>ì£¼ë¬¸ ë‚ ì§œ</th>
                                <th>ì£¼ë¬¸ ì‹œê°„</th>
                                <th>ëª©ì ì§€</th>
                                <th>ìƒí’ˆ ID</th>
                            </tr>
                        </thead>
                        <tbody id="orderTableBody">
                            <!-- ì£¼ë¬¸ ë°ì´í„°ê°€ ì—¬ê¸°ì— ì¶”ê°€ë¨ -->
                        </tbody>
                    </table>
                </div>

                <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
                <div class="pagination">
                    <button id="prevGroup">Â«</button>
                    <span id="pageNumbers"></span>
                    <button id="nextGroup">Â»</button>
                </div>

            </div>
        </div>
    </div>
</th:block>

<script>
    let currentPage = 1;
    const rowsPerPage = 20;
    const pageGroupSize = 10;
    let totalPages = 1;
    let orders = [];

    window.onload = () => loadOrders();

    document.getElementById("filterBtn").addEventListener("click", function () {
        currentPage = 1;
        loadOrders();
    });

    document.getElementById("generateOrderBtn").addEventListener("click", function () {
        fetch("/admin/order/generate", { method: "POST" })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                setTimeout(() => location.reload(), 1000);  // âœ… ì£¼ë¬¸ ìƒì„± í›„ ìë™ ìƒˆë¡œê³ ì¹¨
            })
            .catch(error => console.error("Error:", error));
    });

    document.getElementById("searchOrderBtn").addEventListener("click", function () {
        searchOrderByNum();
    });

    document.getElementById("orderNumSearch").addEventListener("keypress", function (event) {
        if (event.key === "Enter") {
            searchOrderByNum();
        }
    });

    function searchOrderByNum() {
        let orderNum = document.getElementById("orderNumSearch").value.trim();

        if (orderNum === "") {
            loadOrders();  // ì£¼ë¬¸ë²ˆí˜¸ ì…ë ¥ì´ ë¹„ì–´ ìˆìœ¼ë©´ ì „ì²´ ì£¼ë¬¸ì„ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ê¸°
            return;
        }

        fetch(`/admin/order/api/search?orderNum=${orderNum}`)
            .then(response => {
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error("âŒ í•´ë‹¹ ì£¼ë¬¸ë²ˆí˜¸ë¡œ ì¡°íšŒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");
                    }
                    throw new Error("âŒ ì„œë²„ ì˜¤ë¥˜ ë°œìƒ");
                }
                return response.json();
            })
            .then(data => {
                if (!data.orders || data.orders.length === 0) {
                    alert("âŒ í•´ë‹¹ ì£¼ë¬¸ë²ˆí˜¸ë¡œ ì¡°íšŒëœ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.");
                    document.getElementById("orderTableBody").innerHTML =
                        "<tr><td colspan='6' style='text-align:center;'>âŒ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                } else {
                    orders = data.orders;  // âœ… ì£¼ë¬¸ ë°ì´í„° ì—…ë°ì´íŠ¸
                    updateOrderList(orders);  // âœ… ê²€ìƒ‰ëœ ì£¼ë¬¸ ë¦¬ìŠ¤íŠ¸ë¥¼ UIì— ë°˜ì˜
                }
            })
            .catch(error => {
                alert(error.message); // âŒ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼
                document.getElementById("orderTableBody").innerHTML =
                    "<tr><td colspan='6' style='text-align:center;'>âŒ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
            });
    }


    document.getElementById("downloadExcelBtn").addEventListener("click", function () {
        window.location.href = "/admin/order/download/excel";
    });

    document.getElementById("prevGroup").addEventListener("click", function () {
        if (currentPage > 1) {
            currentPage--;
            loadOrders();
        }
    });

    document.getElementById("nextGroup").addEventListener("click", function () {
        if (currentPage < totalPages) {
            currentPage++;
            loadOrders();
        }
    });

    function loadOrders(page = currentPage) {
        let date = document.getElementById("dateFilter").value;
        let camp = document.getElementById("campFilter").value;

        let queryParams = new URLSearchParams({ page, size: 20 });
        if (date) queryParams.append("date", date);
        if (camp) queryParams.append("destination", camp);

        fetch(`/admin/order/api?${queryParams.toString()}`)
            .then(response => response.json())
            .then(data => {
                console.log("ğŸ”¥ API ì‘ë‹µ ë°ì´í„°:", data); // âœ… API ì‘ë‹µ í™•ì¸
                orders = data.orders;
                totalPages = data.totalPages || 1;

                updateOrderList();
                updatePagination();
            })
            .catch(error => {
                console.error("âŒ Error:", error);
                document.getElementById("orderTableBody").innerHTML =
                    "<tr><td colspan='8' style='text-align:center;'>âŒ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
            });
    }

    function updateOrderList(orderData = orders) {
        let orderTable = document.getElementById("orderTableBody");
        orderTable.innerHTML = "";

        if (!orderData || orderData.length === 0) {
            orderTable.innerHTML = "<tr><td colspan='6' style='text-align:center;'>âŒ ì£¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
            return;
        }

        console.log("ğŸ”¥ ë Œë”ë§í•  ì£¼ë¬¸ ë°ì´í„°:", orderData); // âœ… ì£¼ë¬¸ ë°ì´í„° í™•ì¸

        orderData.forEach(order => {
            let formattedDate = order.order_time
                ? order.order_time.split("T")[0]
                : order.formattedOrderTime
                    ? order.formattedOrderTime.split("T")[0]
                    : "-";

            let formattedTime = order.order_time
                ? order.order_time.split("T")[1].split(".")[0]
                : order.formattedOrderTime
                    ? order.formattedOrderTime.split("T")[1].split(".")[0]
                    : "-";

            let row = `<tr>
                <td>${order.order_id || '-'}</td>
                <td>${order.order_num || '-'}</td>
                <td>${formattedDate}</td>
                <td>${formattedTime}</td>
                <td>${order.destination || '-'}</td>
                <td>${order.product_id || '-'}</td>
            </tr>`;
            orderTable.innerHTML += row;
        });
    }

    function updatePagination() {
        let pageNumbers = document.getElementById("pageNumbers");
        pageNumbers.innerHTML = "";

        let startPage = Math.max(1, Math.floor((currentPage - 1) / pageGroupSize) * pageGroupSize + 1);
        let endPage = Math.min(startPage + pageGroupSize - 1, totalPages);

        for (let i = startPage; i <= endPage; i++) {
            let pageButton = document.createElement("button");
            pageButton.innerText = i;
            pageButton.classList.add("page-btn");

            if (i === currentPage) {
                pageButton.classList.add("active");
            }

            pageButton.addEventListener("click", function () {
                currentPage = i;
                loadOrders(i);
            });

            pageNumbers.appendChild(pageButton);
        }

        document.getElementById("prevGroup").disabled = (currentPage === 1);
        document.getElementById("nextGroup").disabled = (currentPage === totalPages);
    }
</script>

<style>
    .table-container { max-height: 500px; overflow-y: auto; margin-top: 10px; }
    .order-table { width: 100%; border-collapse: collapse; }
    .order-table th, .order-table td { padding: 10px; border: 1px solid #ddd; text-align: center; }
    .pagination { display: flex; justify-content: center; margin-top: 10px; }
    .pagination button { padding: 5px 10px; margin: 2px; border: none; background: #eee; cursor: pointer; }
    .pagination .active { background: #6200ea; color: white; }
</style>
</body>
</html>
