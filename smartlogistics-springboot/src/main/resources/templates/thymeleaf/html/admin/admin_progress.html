<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="~{/thymeleaf/html/common/default_layout}">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/admin/admin.css}" />
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
	    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
	</th:block>
</head>

<body>
<th:block layout:fragment="wrapper">
    <div class="outside-container">
        <div class="main-container">
            <div th:replace="~{thymeleaf/html/common/include::profile}"></div>
            <div th:replace="~{thymeleaf/html/common/include::sidebar}"></div>
            <div layout:fragment="content" class="main-content">

                <!-- 필터 컨테이너 -->
                <div class="filter-container">
                    <label for="boxSpecFilter">박스 규격:</label>
                    <select id="boxSpecFilter">
                        <option value="">전체</option>
                        <option value="1">1호</option>
                        <option value="2">2호</option>
                        <option value="3">3호</option>
                        <option value="4">4호</option>
                        <option value="5">5호</option>
                        <option value="6">6호</option>
                    </select>

                    <label for="boxStateFilter">박스 상태:</label>
                    <select id="boxStateFilter">
                        <option value="">전체</option>
                        <option value="0">미검사</option>
                        <option value="1">정상</option>
                        <option value="2">파손</option>
                    </select>

                    <label for="progressStateFilter">진행 상태:</label>
                    <select id="progressStateFilter">
                        <option value="">전체</option>
                        <option value="0">물품 대기</option>
                        <option value="1">포장 완료</option>
                        <option value="2">적재 완료</option>
                    </select>

                    <button id="filterBtn">조회</button>
                </div>

                <!-- 진행 상태 테이블 -->
                <div class="table-container">
                    <table class="progress-table">
                        <thead>
                            <tr>
                                <th>주문 ID</th>
                                <th>상품명</th>
                                <th>카테고리</th>
                                <th>주문 시간</th>
                                <th>박스규격</th>
                                <th>팔렛트 ID</th>
                                <th>박스 상태</th>
                                <th>진행 상태</th>
                            </tr>
                        </thead>
                        <tbody id="progressTableBody"></tbody>
                    </table>
                </div>

                <!-- 페이지네이션 -->
                <div class="pagination">
                    <button id="prevGroup">«</button>
                    <span id="pageNumbers"></span>
                    <button id="nextGroup">»</button>
                </div>
            </div>
        </div>
    </div>
</th:block>
<script>
let currentPage = 1;
const rowsPerPage = 10;
const pageGroupSize = 10;
let totalPages = 1;
let progressData = [];

window.onload = () => {
    loadProgress();
    connectWebSocket();
};

function connectWebSocket() {
    let socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function(frame) {
        console.log('📌 WebSocket 연결됨:', frame);

        stompClient.subscribe('/topic/updateStatus', function(message) {
            let updatedProgress = JSON.parse(message.body);
            console.log("📌 WebSocket으로 받은 업데이트 데이터:", updatedProgress);
            updateProgressFromWebSocket(updatedProgress);
        });

        stompClient.subscribe('/topic/progress', function(message) {
            let data = JSON.parse(message.body);
            console.log("📌 WebSocket 수신 데이터:", data);
            updateProgressFromWebSocket(data);
        });
    }, function(error) {
        console.error('📌 WebSocket 연결 실패:', error);
        setTimeout(connectWebSocket, 5000);
    });
}


function updateProgressFromWebSocket(updatedData) {
    if (!updatedData.orderIds || !Array.isArray(updatedData.orderIds)) return;

    updatedData.orderIds.forEach(orderId => {
        let row = document.querySelector(`tr[data-order-id='${orderId}']`);
        if (row) {
            let progressStateCell = row.querySelector(".progress-state");
            if (progressStateCell) {
                progressStateCell.innerText =
                    updatedData.progressState == 1 ? "포장 완료" :
                    updatedData.progressState == 2 ? "적재 완료" : "물품 대기";
            }
        }
    });
}

// 필터 이벤트 리스너 등록
document.addEventListener("DOMContentLoaded", function () {
    document.getElementById("boxSpecFilter").addEventListener("change", applyFilters);
    document.getElementById("boxStateFilter").addEventListener("change", applyFilters);
    document.getElementById("progressStateFilter").addEventListener("change", applyFilters);
    document.getElementById("filterBtn").addEventListener("click", applyFilters);
    document.getElementById("prevGroup").addEventListener("click", prevPageGroup);
    document.getElementById("nextGroup").addEventListener("click", nextPageGroup);
});

//✅ 필터 적용 후 데이터 다시 로드
function applyFilters() {
    console.log("📌 필터 적용됨 ✅ 현재 페이지를 1로 초기화 후 데이터 로드");
    currentPage = 1;
    loadProgress();
}

function prevPageGroup() {
    if (currentPage > 1) {
        currentPage--;
        loadProgress();
    }
}

function nextPageGroup() {
    if (currentPage < totalPages) {
        currentPage++;
        loadProgress();
    }
}

//✅ 페이지네이션 업데이트
function updatePagination() {
    let pageNumbers = document.getElementById("pageNumbers");
    pageNumbers.innerHTML = "";

    let startPage = Math.max(1, Math.floor((currentPage - 1) / pageGroupSize) * pageGroupSize + 1);
    let endPage = Math.min(startPage + pageGroupSize - 1, totalPages);

    for (let i = startPage; i <= endPage; i++) {
        let pageButton = document.createElement("button");
        pageButton.innerText = i;
        pageButton.classList.add("page-btn");

        if (i === currentPage) {
            pageButton.classList.add("active");
        }

        pageButton.addEventListener("click", function () {
            currentPage = i;
            loadProgress();
        });

        pageNumbers.appendChild(pageButton);
    }

    document.getElementById("prevGroup").disabled = (currentPage === 1);
    document.getElementById("nextGroup").disabled = (currentPage === totalPages);
}

//✅ 데이터 로드 함수 (필터 적용)
function loadProgress() {
    let boxSpec = document.getElementById("boxSpecFilter").value;
    let boxState = document.getElementById("boxStateFilter").value;
    let progressState = document.getElementById("progressStateFilter").value;

    let queryParams = new URLSearchParams({ page: currentPage, size: rowsPerPage });

    // ✅ 필터 값이 존재할 경우에만 추가
    if (boxSpec && boxSpec !== "전체") queryParams.append("boxSpec", boxSpec);
    if (boxState && boxState !== "전체") queryParams.append("boxState", boxState);
    if (progressState && progressState !== "전체") queryParams.append("progressState", progressState);

    console.log("📌 필터링 요청 URL:", `/admin/progress/data?${queryParams.toString()}`);

    fetch(`/admin/progress/data?${queryParams.toString()}`)
    .then(response => {
        if (!response.ok) throw new Error(`HTTP 오류! 상태 코드: ${response.status}`);
        return response.json();
    })
    .then(data => {
        console.log("📌 서버 응답 데이터:", data);

        if (!data || !data.progressList) {
            console.error("🚨 서버 응답 데이터가 유효하지 않습니다.", data);
            updateProgressList([]); 
            return;
        }

        progressData = data.progressList || [];
        totalPages = data.totalPages || 1;

        console.log("📌 서버에서 받은 데이터 개수:", progressData.length);
        console.log("📌 총 페이지 수 업데이트:", totalPages);

        updateProgressList(progressData);
        updatePagination();
    })
    .catch(error => {
        console.error("🚨 데이터 로드 오류:", error);
        updateProgressList([]);
    });
}

function convertUtcToKst(utcTime) {
    if (!utcTime) return '-';

    let orderDate = new Date(Date.parse(utcTime));
    let formattedTime = orderDate.toTimeString().split(" ")[0];
    return formattedTime;
}

//✅ 테이블 업데이트
function updateProgressList(data) {
    let progressTable = document.getElementById("progressTableBody");
    progressTable.innerHTML = "";

    if (!data || data.length === 0) {
        progressTable.innerHTML = "<tr><td colspan='8' style='text-align:center;'>❌ 조회된 주문이 없습니다.</td></tr>";
        return;
    }

    data.forEach(progress => {
        let orderTime = convertUtcToKst(progress.orderTime);
        
        // ✅ boxSpec이 0이거나 NULL이면 "-"로 표시
        let boxSpecValue = (progress.boxSpec === null || progress.boxSpec === undefined || progress.boxSpec === 0) ? '-' : progress.boxSpec;

        console.log(`📦 [UI 업데이트] 주문 ID: ${progress.orderId}, boxSpec: ${boxSpecValue}`);

        let row = `<tr data-order-id="${progress.orderId}">
            <td>${progress.orderId || '-'}</td>
            <td>${progress.productName || '-'}</td>
            <td>${progress.productCategory || '-'}</td>
            <td>${orderTime}</td>
            <td>${boxSpecValue}</td>  <!-- ✅ 수정된 부분 -->
            <td>${progress.palletId || '-'}</td>
            <td>${progress.boxState == 0 ? '미검사' : progress.boxState == 1 ? '정상' : '파손'}</td>
            <td class="progress-state">
                ${progress.progressState == 0 ? '물품 대기' : progress.progressState == 1 ? '포장 완료' : '적재 완료'}
            </td>
        </tr>`;
        progressTable.innerHTML += row;
    });
}



</script>
<style>
    .table-container { max-height: 500px; overflow-y: auto; margin-top: 10px; }
    .order-table { width: 100%; border-collapse: collapse; }
    .order-table th, .order-table td { padding: 10px; border: 1px solid #ddd; text-align: center; }
    .pagination { display: flex; justify-content: center; margin-top: 10px; }
    .pagination button { padding: 5px 10px; margin: 2px; border: none; background: #eee; cursor: pointer; }
    .pagination .active { background: #6200ea; color: white; }
    
    .table-container {
        width: 100%;
        max-height: 500px;
        overflow-y: auto;
        overflow-x: auto;
        margin-top: 10px;
    }

    .progress-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed;
    }

    .progress-table th {
        background: #f4f4f4;
        padding: 12px;
        border: 1px solid #ddd;
        text-align: center;
        font-weight: bold;
    }

    .progress-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .progress-table th:nth-child(1),
    .progress-table td:nth-child(1) {
        width: 15%;
    }

    .progress-table th:nth-child(2),
    .progress-table td:nth-child(2) {
        width: 20%;
    }

    .progress-table th:nth-child(3),
    .progress-table td:nth-child(3) {
        width: 10%;
    }

    .progress-table th:nth-child(4),
    .progress-table td:nth-child(4) {
        width: 15%;
    }

    .progress-table th:nth-child(5),
    .progress-table td:nth-child(5) {
        width: 10%;
    }

    .progress-table th:nth-child(6),
    .progress-table td:nth-child(6) {
        width: 10%;
    }

    .progress-table th:nth-child(7),
    .progress-table td:nth-child(7) {
        width: 10%;
    }

    .progress-table th:nth-child(8),
    .progress-table td:nth-child(8) {
        width: 10%;
    }

    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 10px;
    }

    .pagination button {
        padding: 8px 12px;
        margin: 2px;
        border: none;
        background: #eee;
        cursor: pointer;
        border-radius: 4px;
    }

    .pagination .active {
        background: #6200ea;
        color: white;
    }
</style>
</body>
</html>