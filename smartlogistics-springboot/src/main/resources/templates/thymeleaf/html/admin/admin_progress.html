<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="~{/thymeleaf/html/common/default_layout}">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/admin/admin.css}" />
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
	    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
	</th:block>
</head>

<body>
<th:block layout:fragment="wrapper">
    <div class="outside-container">
        <div class="main-container">
            <div th:replace="~{thymeleaf/html/common/include::profile}"></div>
            <div th:replace="~{thymeleaf/html/common/include::sidebar}"></div>
            <div layout:fragment="content" class="main-content">

                <!-- í•„í„° ì»¨í…Œì´ë„ˆ -->
                <div class="filter-container">
                    <label for="dateFilter">ë‚ ì§œ:</label>
                    <input type="date" id="dateFilter"/>

                    <label for="campFilter">ìº í”„:</label>
                    <select id="campFilter">
                        <option value="">ì „ì²´</option>
                        <option value="ì„œì´ˆ ìº í”„">ì„œì´ˆ ìº í”„</option>
                        <option value="ê°•ë‚¨ ìº í”„">ê°•ë‚¨ ìº í”„</option>
                        <option value="ê°•ì„œ ìº í”„">ê°•ì„œ ìº í”„</option>
                        <option value="ì¤‘êµ¬ ìº í”„">ì¤‘êµ¬ ìº í”„</option>
                        <option value="ì„±ë™ ìº í”„">ì„±ë™ ìº í”„</option>
                    </select>
                    
                    <button id="filterBtn">ì¡°íšŒ</button>

                    <label for="orderIdSearch">ì£¼ë¬¸ ID:</label>
					<input type="text" id="orderIdSearch" placeholder="ì£¼ë¬¸ ID ì…ë ¥" />
					<button id="searchOrderBtn">ê²€ìƒ‰</button>

                </div>

                <!-- ì§„í–‰ ìƒíƒœ í…Œì´ë¸” -->
                <div class="table-container">
                    <table class="progress-table">
                        <thead>
                            <tr>
                                <th>ì£¼ë¬¸ ID</th>
                                <th>ìƒí’ˆëª…</th>
                                <th>ì¹´í…Œê³ ë¦¬</th>
                                <th>ì£¼ë¬¸ ì‹œê°„</th>
                                <th>ë°•ìŠ¤ê·œê²©</th>
                                <th>íŒ”ë ›íŠ¸ ID</th>
                                <th>ë°•ìŠ¤ ìƒíƒœ</th>
                                <th>ì§„í–‰ ìƒíƒœ</th>
                            </tr>
                        </thead>
                        <tbody id="progressTableBody"></tbody>
                    </table>
                </div>

                <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
                <div class="pagination">
                    <button id="prevGroup">Â«</button>
                    <span id="pageNumbers"></span>
                    <button id="nextGroup">Â»</button>
                </div>
            </div>
        </div>
    </div>
</th:block>

<script>
let currentPage = 1;
const rowsPerPage = 10;
const pageGroupSize = 10;
let totalPages = 1;
let progressData = [];

window.onload = () => {
    loadProgress();
    connectWebSocket(); // âœ… WebSocket ì—°ê²° ì¶”ê°€
};

// âœ… WebSocket ì—°ê²° ì„¤ì •
function connectWebSocket() {
    let socket = new SockJS('/ws');
    stompClient = Stomp.over(socket);

    stompClient.connect({}, function(frame) {
        console.log('ğŸ“Œ WebSocket ì—°ê²°ë¨:', frame);

        // âœ… ì§„í–‰ ìƒíƒœ ë³€ê²½ êµ¬ë… (Worker & Progress í˜ì´ì§€ ë™ê¸°í™”)
        stompClient.subscribe('/topic/updateStatus', function(message) {
            let updatedProgress = JSON.parse(message.body);
            console.log("ğŸ“Œ WebSocketìœ¼ë¡œ ë°›ì€ ì—…ë°ì´íŠ¸ ë°ì´í„°:", updatedProgress);
            updateProgressFromWebSocket(updatedProgress);
        });

        // âœ… ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
        stompClient.subscribe('/topic/progress', function(message) {
            let data = JSON.parse(message.body);
            console.log("ğŸ“Œ WebSocket ìˆ˜ì‹  ë°ì´í„°:", data);
            updateProgressFromWebSocket(data);
        });
    }, function(error) {
        console.error('ğŸ“Œ WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
        setTimeout(connectWebSocket, 5000);  // 5ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„
    });
}


//âœ… WebSocketìœ¼ë¡œ ë°›ì€ ë°ì´í„° ì—…ë°ì´íŠ¸ (UI ë°˜ì˜)
function updateProgressFromWebSocket(updatedData) {
    console.log("ğŸ“Œ [WebSocket] ì—…ë°ì´íŠ¸ ë°ì´í„°:", updatedData);

    // âœ… ë°ì´í„° ê²€ì¦
    if (!updatedData.orderIds || !Array.isArray(updatedData.orderIds)) {
        console.warn("ğŸ“Œ [WebSocket] ì˜ëª»ëœ ë°ì´í„° í˜•ì‹:", updatedData);
        return;
    }
    if (updatedData.progressState === undefined || updatedData.progressState === null) {
        console.warn("ğŸ“Œ [WebSocket] progressState ì—†ìŒ:", updatedData);
        return;
    }

    // âœ… íŠ¹ì • ì£¼ë¬¸ IDë§Œ ì—…ë°ì´íŠ¸
    updatedData.orderIds.forEach(orderId => {
        let row = document.querySelector(`tr[data-order-id='${orderId}']`);
        
        if (row) {
            console.log("ğŸ“Œ [WebSocket] ì£¼ë¬¸ ID:", orderId, "ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸");

            let progressStateCell = row.querySelector(".progress-state");
            if (progressStateCell) {
                progressStateCell.innerText = 
                    updatedData.progressState == 1 ? "í¬ì¥ ì™„ë£Œ" : 
                    updatedData.progressState == 2 ? "ì ì¬ ì™„ë£Œ" : "ë¬¼í’ˆ ëŒ€ê¸°";
            }
        } else {
            console.warn("ğŸ“Œ [WebSocket] í•´ë‹¹ ì£¼ë¬¸ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:", orderId);
        }
    });
}


// ì¡°íšŒ ë²„íŠ¼ í´ë¦­
document.getElementById("filterBtn").addEventListener("click", function () {
    currentPage = 1;
    loadProgress(currentPage);
});

// ì£¼ë¬¸ë²ˆí˜¸ ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­
document.getElementById("searchOrderBtn").addEventListener("click", function () {
    searchProgressByNum();
});

// Enter í‚¤ ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€
document.getElementById("orderNumSearch").addEventListener("keypress", function (event) {
    if (event.key === "Enter") {
        searchProgressByNum();
    }
});

// ì´ì „ / ë‹¤ìŒ ë²„íŠ¼ ì´ë²¤íŠ¸
document.getElementById("prevGroup").addEventListener("click", function () {
    if (currentPage > 1) {
        currentPage--; // âœ… í•œ í˜ì´ì§€ì”© ê°ì†Œ
        loadProgress(currentPage);
    }
});

document.getElementById("nextGroup").addEventListener("click", function () {
    if (currentPage < totalPages) {
        currentPage++; // âœ… í•œ í˜ì´ì§€ì”© ì¦ê°€
        loadProgress(currentPage);
    }
});

//í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
function updatePagination() {
    let pageNumbers = document.getElementById("pageNumbers");
    pageNumbers.innerHTML = "";

    let startPage = Math.max(1, Math.floor((currentPage - 1) / pageGroupSize) * pageGroupSize + 1);
    let endPage = Math.min(startPage + pageGroupSize - 1, totalPages);

    console.log("ğŸ“Œ í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸:", startPage, "â†’", endPage, "ì´ í˜ì´ì§€ ìˆ˜:", totalPages);

    for (let i = startPage; i <= endPage; i++) {
        let pageButton = document.createElement("button");
        pageButton.innerText = i;
        pageButton.classList.add("page-btn");

        if (i === currentPage) {
            pageButton.classList.add("active");
        }

        pageButton.addEventListener("click", function () {
            console.log("ğŸ“Œ í˜ì´ì§€ í´ë¦­ë¨:", i);
            if (currentPage !== i) { // ì¤‘ë³µ ìš”ì²­ ë°©ì§€
                currentPage = i;
                loadProgress(i);
            }
        });

        pageNumbers.appendChild(pageButton);
    }

    // âœ… ë²„íŠ¼ ìš”ì†Œ ì°¾ê¸°
    let prevButton = document.getElementById("prevGroup");
    let nextButton = document.getElementById("nextGroup");

    if (!prevButton || !nextButton) {
        console.error("âŒ í˜ì´ì§€ë„¤ì´ì…˜ ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }

    // âœ… ê¸°ì¡´ ì´ë²¤íŠ¸ ì œê±° (ì´ë²¤íŠ¸ ì¤‘ë³µ ë°©ì§€)
    prevButton.replaceWith(prevButton.cloneNode(true));
    nextButton.replaceWith(nextButton.cloneNode(true));

    // âœ… ìƒˆë¡œ ë²„íŠ¼ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸° (ì´ë²¤íŠ¸ê°€ ì—†ëŠ” ìƒˆ ë…¸ë“œ)
    prevButton = document.getElementById("prevGroup");
    nextButton = document.getElementById("nextGroup");

    // âœ… ë²„íŠ¼ ìƒíƒœ ì„¤ì •
    prevButton.disabled = (currentPage === 1);
    nextButton.disabled = (currentPage >= totalPages);

    // âœ… ì´ì „ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
    prevButton.addEventListener("click", function () {
        if (currentPage > 1) {
            currentPage--;
            loadProgress(currentPage);
        }
    });

    // âœ… ë‹¤ìŒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë“±ë¡
    nextButton.addEventListener("click", function () {
        if (currentPage < totalPages) {
            currentPage++;
            loadProgress(currentPage);
        }
    });

    console.log("ğŸ“Œ ì´ì „ ë²„íŠ¼ ìƒíƒœ:", prevButton.disabled);
    console.log("ğŸ“Œ ë‹¤ìŒ ë²„íŠ¼ ìƒíƒœ:", nextButton.disabled);
}


// ì§„í–‰ ìƒíƒœ ì¡°íšŒ
function loadProgress(page = currentPage) {
    let date = document.getElementById("dateFilter").value;
    let camp = document.getElementById("campFilter").value;

    let queryParams = new URLSearchParams({ page, size: 20 });
    if (date) queryParams.append("date", date);
    if (camp) queryParams.append("camp", camp);

    fetch(`/admin/progress/data?${queryParams.toString()}`)
    .then(response => response.json())
    .then(data => {
        progressData = data.progressList;
        totalPages = data.totalPages || 1;  // âœ… totalPages ê°’ì´ 1 ì´ìƒì¸ì§€ í™•ì¸

        console.log("ğŸ“Œ ì„œë²„ì—ì„œ ë°›ì€ totalPages:", totalPages);
        
        updateProgressList();
        updatePagination();
    })
    .catch(error => {
        console.error("Error:", error);
    });

}

document.addEventListener("DOMContentLoaded", function () {
    console.log("ğŸ“Œ DOM ë¡œë“œ ì™„ë£Œ");

    let prevButton = document.getElementById("prevGroup");
    let nextButton = document.getElementById("nextGroup");

    if (prevButton) {
        prevButton.addEventListener("click", function () {
            console.log("â¬… ì´ì „ í˜ì´ì§€ ë²„íŠ¼ í´ë¦­ë¨, í˜„ì¬ í˜ì´ì§€:", currentPage);
            if (currentPage > 1) {
                currentPage--;
                loadProgress(currentPage);
            }
        });
    } else {
        console.error("âŒ ì´ì „ ë²„íŠ¼(prevGroup)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }

    if (nextButton) {
        nextButton.addEventListener("click", function () {
            console.log("â¡ ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼ í´ë¦­ë¨, í˜„ì¬ í˜ì´ì§€:", currentPage, "ì´ í˜ì´ì§€ ìˆ˜:", totalPages);
            if (currentPage < totalPages) {
                currentPage++;
                loadProgress(currentPage);
            }
        });
    } else {
        console.error("âŒ ë‹¤ìŒ ë²„íŠ¼(nextGroup)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
});


// ì£¼ë¬¸ë²ˆí˜¸ ê²€ìƒ‰ ê¸°ëŠ¥
// âœ… ì£¼ë¬¸ ID ê²€ìƒ‰ ê¸°ëŠ¥
function searchProgressById() {
    let orderId = document.getElementById("orderIdSearch").value.trim();

    if (!orderId) {
        loadProgress(1);
        return;
    }

    fetch(`/admin/progress/data?orderId=${orderId}`) // âœ… orderNum â†’ orderIdë¡œ ë³€ê²½
        .then(response => response.json())
        .then(data => {
            progressData = data.progressList;
            updateProgressList();
        })
        .catch(error => {
            console.error("Error:", error);
            document.getElementById("progressTableBody").innerHTML =
                "<tr><td colspan='8' style='text-align:center;'>âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
        });
}

// âœ… ê²€ìƒ‰ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ê¸°ì¡´ `orderNumSearch` â†’ `orderIdSearch`ë¡œ ë³€ê²½)
document.getElementById("searchOrderBtn").addEventListener("click", function () {
    searchProgressById();
});

// âœ… Enter í‚¤ë¡œ ê²€ìƒ‰ ê°€ëŠ¥í•˜ë„ë¡ ìˆ˜ì •
document.getElementById("orderIdSearch").addEventListener("keypress", function (event) {
    if (event.key === "Enter") {
        searchProgressById();
    }
});



//UTC â†’ KST ë³€í™˜ í•¨ìˆ˜
// âœ… UTC â†’ KST ë³€í™˜ í•¨ìˆ˜ (ì‹œê°„ ë³€í™˜ ë¬¸ì œ í•´ê²°)
function convertUtcToKst(utcTime) {
    if (!utcTime) return '-'; // ê°’ì´ ì—†ìœ¼ë©´ '-' ë°˜í™˜

    let orderDate = new Date(Date.parse(utcTime)); // UTC ê¸°ì¤€ Date ê°ì²´ ìƒì„±
    orderDate.setHours(orderDate.getHours() ); // KST ë³€í™˜ ì ìš©
    let formattedTime = orderDate.toTimeString().split(" ")[0]; // HH:MM:SS í˜•ì‹ ë³€í™˜
    return formattedTime;
}

// âœ… ì§„í–‰ ìƒíƒœ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
function updateProgressList() {
    let progressTable = document.getElementById("progressTableBody");
    progressTable.innerHTML = "";

    console.log("ğŸ“Œ í˜„ì¬ progressData:", progressData);  // âœ… ë°ì´í„° í™•ì¸

    if (!progressData || progressData.length === 0) {
        progressTable.innerHTML = "<tr><td colspan='8' style='text-align:center;'>âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
        return;
    }

    progressData.forEach(progress => {
        let orderTime = convertUtcToKst(progress.orderTime); // âœ… ë³€í™˜ëœ KST ì‹œê°„ ì ìš©
        
        let row = `<tr data-order-id="${progress.orderId}">
            <td>${progress.orderId || '-'}</td> <!-- ì£¼ë¬¸ ID -->
            <td>${progress.productName || '-'}</td>
            <td>${progress.productCategory || '-'}</td>
            <td>${orderTime}</td>
            <td>${progress.boxSpec || '-'}</td> <!-- ë°•ìŠ¤ ê·œê²© -->
            <td>${progress.palletId || '-'}</td>
            <td>${progress.boxState == 0 ? 'ë¯¸ê²€ì‚¬' : progress.boxState == 1 ? 'ì •ìƒ' : 'íŒŒì†'}</td>
            <td class="progress-state">
                ${progress.progressState == 0 ? 'ë¬¼í’ˆ ëŒ€ê¸°' : progress.progressState == 1 ? 'í¬ì¥ ì™„ë£Œ' : 'ì ì¬ ì™„ë£Œ'}
            </td>
        </tr>`;
        progressTable.innerHTML += row;
    });
}

</script>
<style>
    .table-container { max-height: 500px; overflow-y: auto; margin-top: 10px; }
    .order-table { width: 100%; border-collapse: collapse; }
    .order-table th, .order-table td { padding: 10px; border: 1px solid #ddd; text-align: center; }
    .pagination { display: flex; justify-content: center; margin-top: 10px; }
    .pagination button { padding: 5px 10px; margin: 2px; border: none; background: #eee; cursor: pointer; }
    .pagination .active { background: #6200ea; color: white; }
    
    /* í…Œì´ë¸” ì»¨í…Œì´ë„ˆ */
    .table-container {
        width: 100%;
        max-height: 500px;
        overflow-y: auto;
        overflow-x: auto;
        margin-top: 10px;
    }

    /* í…Œì´ë¸” */
    .progress-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed; /* ì—´ ë„ˆë¹„ ê³ ì • */
    }

    /* í…Œì´ë¸” í—¤ë” */
    .progress-table th {
        background: #f4f4f4;
        padding: 12px;
        border: 1px solid #ddd;
        text-align: center;
        font-weight: bold;
    }

    /* í…Œì´ë¸” ë³¸ë¬¸ */
    .progress-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
        white-space: nowrap; /* í…ìŠ¤íŠ¸ ì¤„ ë°”ê¿ˆ ë°©ì§€ */
        overflow: hidden;
        text-overflow: ellipsis; /* ë„ˆë¬´ ê¸¸ë©´ ... ì²˜ë¦¬ */
    }

    /* ê° ì—´ í¬ê¸° ê³ ì • */
    .progress-table th:nth-child(1),
    .progress-table td:nth-child(1) {
        width: 15%; /* ì£¼ë¬¸ë²ˆí˜¸ */
    }

    .progress-table th:nth-child(2),
    .progress-table td:nth-child(2) {
        width: 20%; /* ìƒí’ˆëª… */
    }

    .progress-table th:nth-child(3),
    .progress-table td:nth-child(3) {
        width: 10%; /* ì¹´í…Œê³ ë¦¬ */
    }

    .progress-table th:nth-child(4),
    .progress-table td:nth-child(4) {
        width: 15%; /* ì£¼ë¬¸ ì‹œê°„ */
    }

    .progress-table th:nth-child(5),
    .progress-table td:nth-child(5) {
        width: 10%; /* ë°°ì†¡ì§€ */
    }

    .progress-table th:nth-child(6),
    .progress-table td:nth-child(6) {
        width: 10%; /* íŒ”ë ›íŠ¸ ID */
    }

    .progress-table th:nth-child(7),
    .progress-table td:nth-child(7) {
        width: 10%; /* ë°•ìŠ¤ ìƒíƒœ */
    }

    .progress-table th:nth-child(8),
    .progress-table td:nth-child(8) {
        width: 10%; /* ì§„í–‰ ìƒíƒœ */
    }

    /* í˜ì´ì§€ë„¤ì´ì…˜ ìŠ¤íƒ€ì¼ */
    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 10px;
    }

    .pagination button {
        padding: 8px 12px;
        margin: 2px;
        border: none;
        background: #eee;
        cursor: pointer;
        border-radius: 4px;
    }

    .pagination .active {
        background: #6200ea;
        color: white;
    }
</style>
</body>
</html>
