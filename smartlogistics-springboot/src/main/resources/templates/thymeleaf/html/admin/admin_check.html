<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorator="~{/thymeleaf/html/common/default_layout}">
<head>
	<th:block layout:fragment="css">
		<link rel="stylesheet" th:href="@{/css/admin/admin.css}" />
		<script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
	    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
	    <style>
	    	#contentContainer {
		        display: flex;           /* ì¢Œìš° ë°°ì¹˜ */
		        justify-content: space-between; /* ê³µê°„ ê· ë“± ë¶„ë°° */
		        align-items: center;    /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
		    }
		    
		    #imageContainer {
		        display: flex;
		        flex-direction: column;
		        align-items: center;
		    }
		    
			#boxImage {
				width: 1000px;
				height: 1000px;
				object-fit: cover; /* ì´ë¯¸ì§€ ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ ë°•ìŠ¤ í¬ê¸°ì— ë§ì¶¤ */
				box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			}
			.hidden {
				display: none;
			}
			
			#check_result {
				width: 1000px;
				height: 1000px;
			}
		</style>
	</th:block>
</head>

<th:block layout:fragment="wrapper">
    	<div class="outside-container">
        	<div class="main-container">
                <div th:replace="~{thymeleaf/html/common/include::profile}"></div>
				<div th:replace="~{thymeleaf/html/common/include::sidebar}"></div>
            	<div layout:fragment="content" class="main-content">
            		<!-- âœ… ğŸ“¦ ì´ë¯¸ì§€ì™€ ê²°ê³¼ë¥¼ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ ì¶”ê°€ -->
                	<div id="contentContainer" class="mt-4">
                    <!-- ğŸ“¦ ì„ íƒëœ ë°•ìŠ¤ ì´ë¯¸ì§€ í‘œì‹œ ì˜ì—­ -->
	                    <div id="imageContainer">
	                        <img id="boxImage" src="" alt="ë°•ìŠ¤ ì´ë¯¸ì§€" class="hidden" />
	                    </div>
	
	                    <!-- âœ… ë°•ìŠ¤ ê²€ì‚¬ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
	                    <div id="check_result"></div>
	                </div>     
            	</div>
        	</div>
        </div>
</th:block>  
    <!-- âœ… WebSocket ì—°ê²° ë° êµ¬ë… ìŠ¤í¬ë¦½íŠ¸ -->
	<script>
    var socket = new SockJS('/ws');  // /ws/progressë¡œ ì—°ê²°
    var stompClient = Stomp.over(socket);
    
 	// âœ… ë¡œì»¬ìŠ¤í† ë¦¬ì§€ì—ì„œ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
    window.addEventListener('DOMContentLoaded', function () {
        var savedImageUrl = localStorage.getItem('savedImageUrl');
        var savedBoxState = localStorage.getItem('savedBoxState');

        if (savedImageUrl) {
            var boxImage = document.getElementById('boxImage');
            boxImage.src = savedImageUrl;
            boxImage.classList.remove('hidden');
        }

        if (savedBoxState) {
            updateBackgroundColor(parseInt(savedBoxState));
        }
    });
 	
 	// âœ… ë°°ê²½ìƒ‰ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateBackgroundColor(state) {
        var checkResultDiv = document.getElementById("check_result");
        if (checkResultDiv) {
            if (state === 1) {
                checkResultDiv.style.backgroundColor = "green";  // âœ… ì´ˆë¡ìƒ‰ (ì •ìƒ)
            } else if (state === 2) {
                checkResultDiv.style.backgroundColor = "red";  // âœ… ë¹¨ê°„ìƒ‰ (íŒŒì†)
            } else {
                checkResultDiv.style.backgroundColor = "";  // ì´ˆê¸°í™”
            }
        }
    }
	
 	// âœ… ë°•ìŠ¤ ì´ë¯¸ì§€ ë° ë°•ìŠ¤ ìƒíƒœ ì €ì¥ 
    stompClient.connect({}, function (frame) {
        console.log("WebSocket ì—°ê²°ë¨: " + frame);

        stompClient.subscribe('/topic/updateImage', function (messageOutput) {
        	var message = JSON.parse(messageOutput.body);
            var imageUrl = message.imageUrl;
            console.log("ì´ë¯¸ì§€ URL ìˆ˜ì‹ :", imageUrl);

            var boxImage = document.getElementById('boxImage');
            if (boxImage) {
                boxImage.src = imageUrl;
                boxImage.classList.remove('hidden');
                localStorage.setItem('savedImageUrl', imageUrl);
            }
            
            var match = imageUrl.match(/\/images\/boximages\/(\d+)\.jpg/);
            if (match) {
                var imageNumber = parseInt(match[1], 10);
                var boxState = (imageNumber >= 1 && imageNumber <= 70) ? 1 : (imageNumber >= 71 && imageNumber <= 100) ? 2 : 0;

                updateBackgroundColor(boxState);
                localStorage.setItem('savedBoxState', boxState);  // âœ… ë°•ìŠ¤ ìƒíƒœ ì €ì¥
            }
            
            // âœ… ì´ë¯¸ì§€ ë²ˆí˜¸ ì¶”ì¶œ (ì˜ˆ: /images/boximages/008.jpg -> 8)
            /*
            var match = imageUrl.match(/\/images\/boximages\/(\d+)\.jpg/);
            if (match) {
                var imageNumber = parseInt(match[1], 10);  // ìˆ«ì ì¶”ì¶œ ë° ì •ìˆ˜ ë³€í™˜
                console.log("ì´ë¯¸ì§€ ë²ˆí˜¸:", imageNumber);

                var checkResultDiv = document.getElementById("check_result");
                if (checkResultDiv) {
                    if (imageNumber >= 1 && imageNumber <= 70) {
                        checkResultDiv.style.backgroundColor = "#e8f5e9";  // âœ… ì´ˆë¡ìƒ‰ (ì •ìƒ)
                    } else if (imageNumber >= 71 && imageNumber <= 100) {
                        checkResultDiv.style.backgroundColor = "#ffebee";  // âœ… ë¹¨ê°„ìƒ‰ (íŒŒì†)
                    } else {
                        checkResultDiv.style.backgroundColor = "";  // âœ… ë²”ìœ„ ë°–ì´ë©´ ìƒ‰ìƒ ì´ˆê¸°í™”
                    }
                }
            } else {
                console.warn("ì´ë¯¸ì§€ ë²ˆí˜¸ë¥¼ ì¶”ì¶œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
            */
                     
        });
        
     	// âœ… ë°•ìŠ¤ ìƒíƒœ ìˆ˜ì‹  êµ¬ë…
        stompClient.subscribe('/topic/updateBoxState', function (messageOutput) {
            var message = JSON.parse(messageOutput.body);
            var boxState = message.boxState;
            console.log("ë°•ìŠ¤ ìƒíƒœ ìˆ˜ì‹ :", boxState);

            /*
            var checkResultDiv = document.getElementById("check_result");
            if (checkResultDiv) {
                if (boxState === 1) {
                    checkResultDiv.style.backgroundColor = "#e8f5e9";  // ì •ìƒ
                } else if (boxState === 2) {
                    checkResultDiv.style.backgroundColor = "#ffebee";  // íŒŒì†
                }
            }
            */
        });
    });
</script>
</html>