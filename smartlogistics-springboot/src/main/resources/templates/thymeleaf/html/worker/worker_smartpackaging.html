<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="~{/thymeleaf/html/common/default_layout}">

<th:block layout:fragment="css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/admin/admin.css}">
    <link rel="stylesheet" th:href="@{/css/worker/worker_smartpackaging.css}">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</th:block>

<th:block layout:fragment="wrapper">
    <div class="outside-container">
        <div class="main-container">
            <div class="container mt-5">
                <div class="content-wrapper">
                    <div class="row w-100">
                        <!-- ì¬í¬ì¥ ì™„ë£Œ ë¬¸êµ¬ -->
                        <div class="col-12 text-center mb-4">
                            <h2>ì¬í¬ì¥ ì™„ë£Œ</h2>
                        </div>

                        <!-- ë°•ìŠ¤ ì •ë³´ -->
                        <div class="col">
                            <h3 class="text-center">ğŸ“¦ ë°•ìŠ¤ ì •ë³´</h3>
                            <div id="box-info" class="custom-box p-3 border rounded">
                                <p>ë°•ìŠ¤ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </div>
                        </div>

                        <!-- ì™„ì¶©ì¬ í•„ìš” ì—¬ë¶€ -->
                        <div class="col">
                            <h3 class="text-center">ğŸ›  ì™„ì¶©ì¬ í•„ìš” ì—¬ë¶€</h3>
                            <div id="cushion-info" class="custom-box p-3 border rounded">
                                <p>ì™„ì¶©ì¬ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                            </div>
                        </div>

                        <!-- ì¬í¬ì¥ ì™„ë£Œ ë²„íŠ¼ -->
                        <div class="col-12 text-center mt-4">
                            <button class="btn btn-success" onclick="completePackaging()">í¬ì¥ ì™„ë£Œ</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>

<script>
	//WebSocket ì—°ê²°
	var socket = new SockJS('/ws');
	var stompClient = Stomp.over(socket);
	
	stompClient.connect({}, function(frame) {
	    console.log('WebSocket ì—°ê²°ë¨: ' + frame);
	
	    // ì§„í–‰ ìƒíƒœ ë³€ê²½ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì‹ 
	    stompClient.subscribe('/topic/progress', function(message) {
	        var data = JSON.parse(message.body);
	        updateProgressState(data.orderId, data.progressState);
	    });
	});
	
	// ì§„í–‰ ìƒíƒœ ì—…ë°ì´íŠ¸
	function updateProgressState(orderId, progressState) {
	    var row = document.querySelector(`tr[data-order-id='${orderId}']`);
	    if (row) {
	        row.querySelector(".progress-state").innerText = progressState;
	    }
	}
	
	// í¬ì¥ ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
	function completePackaging(orderId) {
	    var message = {
	        orderId: orderId,
	        progressState: "í¬ì¥ ì™„ë£Œ"
	    };
	
	    stompClient.send("/app/updateStatus", {}, JSON.stringify(message));
	    alert("í¬ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
	}

</script>

</html>
