<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="~{/thymeleaf/html/common/default_layout}">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
    </th:block>
</head>

<th:block layout:fragment="wrapper">
    <div class="min-h-screen bg-gray-100 flex flex-col items-center p-6">
        <div class="w-full max-w-6xl bg-white shadow-lg rounded-lg p-6">
            <h3 class="text-2xl font-bold text-gray-800 flex items-center mb-4">
                📦 주문 목록 (포장 담당)
            </h3>

           <!-- 주문 테이블 -->
            <div class="overflow-x-auto">
                <table class="table-auto w-full text-center border-collapse border border-gray-300 rounded-lg shadow-md">
                    <thead class="bg-gray-200 text-gray-700">
                        <tr>
                            <th class="p-3 border border-gray-300">
                                <input type="checkbox" id="selectAllCheckbox" class="cursor-pointer">
                            </th>
                            <th class="p-3 border border-gray-300">주문 ID</th>
                            <th class="p-3 border border-gray-300">상품명</th>
                            <th class="p-3 border border-gray-300">카테고리</th>
                            <th class="p-3 border border-gray-300">주문 시간</th>
                            <th class="p-3 border border-gray-300">박스 상태</th>
                            <th class="p-3 border border-gray-300">진행 상태</th>
                        </tr>
                    </thead>
                    <tbody id="workerOrderTableBody" class="text-gray-800">
                        <tr>
                            <td colspan="7" class="p-4 text-center text-gray-500">❌ 주문 데이터를 불러오는 중...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <!-- 페이지네이션 -->
			<div class="pagination">
                    <button id="prevGroup">«</button>
                    <span id="pageNumbers"></span>
                    <button id="nextGroup">»</button>
            </div>

            <!-- 포장 완료 버튼 -->
            <div class="flex justify-center mt-6">
                <button class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg shadow-md transition duration-300"
                        onclick="completeSelectedPackaging()">
                    ✅ 포장 완료
                </button>
            </div>
        </div>
    </div>
</th:block>

<script>
	//✅ 페이지네이션 변수
	let currentPage = 1;
	const maxVisiblePages = 7; // 한 번에 보이는 페이지 수
	let totalPages = 1;

    // ✅ 주문 목록 가져오기
    function loadWorkerOrders() {
        fetch('/admin/progress/data')
            .then(response => response.json())
            .then(data => {
                console.log("📌 Worker 페이지 주문 목록 응답:", data);

                let tableBody = document.getElementById("workerOrderTableBody");
                tableBody.innerHTML = "";

                if (!data.progressList || data.progressList.length === 0) {
                    tableBody.innerHTML = "<tr><td colspan='7' class='p-4 text-center text-gray-500'>❌ 데이터가 없습니다.</td></tr>";
                    return;
                }

                data.progressList.forEach(order => {
                    let orderTime = convertUtcToKst(order.orderTime);
                    let row = `<tr class="hover:bg-gray-100 transition">
                        <td class="p-3 border border-gray-300">
                            <input type="checkbox" class="order-checkbox" data-id="${order.orderId}" />
                        </td>
                        <td class="p-3 border border-gray-300">${order.orderId}</td>
                        <td class="p-3 border border-gray-300">${order.productName}</td>
                        <td class="p-3 border border-gray-300">${order.productCategory}</td>
                        <td class="p-3 border border-gray-300">${orderTime}</td>
                        <td class="p-3 border border-gray-300">
                            ${order.boxState === 0 ? '미검사' : order.boxState === 1 ? '정상' : '파손'}
                        </td>
                        <td class="p-3 border border-gray-300 progress-state">
                            ${order.progressState === 0 ? '물품 대기' : order.progressState === 1 ? '포장 완료' : '적재 완료'}
                        </td>
                    </tr>`;
                    tableBody.innerHTML += row;
                });

                // 전체 선택 체크박스 이벤트 등록
                document.getElementById("selectAllCheckbox").addEventListener("change", toggleSelectAll);
                document.querySelectorAll(".order-checkbox").forEach(checkbox => {
                    checkbox.addEventListener("change", updateSelectAllCheckbox);
                });
            })
            .catch(error => console.error("📌 Worker 페이지 주문 목록 로딩 실패:", error));
    }

    // ✅ WebSocket 연결 설정
	function connectWebSocket() {
	    let socket = new SockJS('/ws');
	    stompClient = Stomp.over(socket);
	
	    stompClient.connect({}, function(frame) {
	        console.log('📌 Worker 페이지 WebSocket 연결됨:', frame);
	
	        stompClient.send("/topic/workerUpdate", {}, JSON.stringify(message));
	
	        
	        // ✅ 진행 상태 변경 구독 (Worker & Admin 동기화)
	        stompClient.subscribe('/topic/updateStatus', function(message) {
	            let updatedProgress = JSON.parse(message.body);
	            console.log("📌 Worker가 받은 WebSocket 메시지:", updatedProgress);
	            updateProgressState(updatedProgress.orderIds, updatedProgress.progressState, updatedProgress.boxState, updatedProgress.imageNumber);
	        });
	        
	     // ✅ Worker가 자기 자신이 보낸 메시지도 수신할 수 있도록 추가
	        stompClient.subscribe('/topic/workerUpdate', function(message) {
	            let updatedProgress = JSON.parse(message.body);
	            console.log("📌 Worker 자기 자신이 보낸 메시지 수신:", updatedProgress);
	            updateProgressState(updatedProgress.orderIds, updatedProgress.progressState);
	        });
	
	    }, function(error) {
	        console.error('📌 WebSocket 연결 실패:', error);
	        setTimeout(connectWebSocket, 5000);  // 5초 후 재연결 시도
	    });
	}
	
	// ✅ 포장 완료 버튼 클릭 시 WebSocket 메시지 전송
	function completeSelectedPackaging() {
	    let selectedOrders = [];
	    document.querySelectorAll(".order-checkbox:checked").forEach(checkbox => {
	        selectedOrders.push(checkbox.dataset.id);
	    });
	
	    if (selectedOrders.length === 0) {
	        alert("✅ 포장할 주문을 선택하세요.");
	        return;
	    }
	
	    let imageNumber = Math.floor(Math.random() * 100) + 1; // 1~100 랜덤 이미지
	
	    let message = {
	        orderIds: selectedOrders,
	        progressState: 1, // 포장 완료
	        imageNumber: imageNumber
	    };
	
	    console.log("📌 WebSocket 전송 메시지 (Worker → Server):", message);
	
	    // ✅ WebSocket을 통해 상태 변경 요청 전송
	    stompClient.send("/app/updateStatus", {}, JSON.stringify(message));
	    stompClient.send("/topic/updateStatus", {}, JSON.stringify(message));
	
	    
		alert("✅ 선택한 주문이 포장 완료되었습니다.");
	
	}
	
	// ✅ 특정 주문만 상태 업데이트 (Worker & Admin UI 동기화)
	function updateProgressState(orderIds, progressState, boxState = null, imageNumber = null) {
	    orderIds.forEach(orderId => {
	        let row = document.querySelector(`tr[data-order-id='${orderId}']`);
	        if (row) {
	            console.log(`📌 [Worker UI 업데이트] 주문 ID: ${orderId}, 진행 상태: ${progressState}, 박스 상태: ${boxState}, 이미지 번호: ${imageNumber}`);
	
	            // ✅ 진행 상태 업데이트
	            let progressStateCell = row.querySelector(".progress-state");
	            if (progressStateCell) {
	                progressStateCell.innerText =
	                    progressState === 1 ? '✅ 포장 완료' :
	                    progressState === 2 ? '📦 적재 완료' : '⏳ 물품 대기';
	            }
	
	            // ✅ 박스 상태 업데이트
	            if (boxState !== null) {
	                let boxStateCell = row.querySelector(".box-state");
	                if (boxStateCell) {
	                    boxStateCell.innerText =
	                        boxState === 0 ? '⏳ 미검사' :
	                        boxState === 1 ? '✅ 정상' : '❌ 파손';
	                }
	            }
	
	            // ✅ 랜덤 이미지 번호 업데이트
	            if (imageNumber !== null) {
	                let imageCell = row.querySelector(".image-number");
	                if (imageCell) {
	                    imageCell.innerText = `📦 ${imageNumber}`;
	                }
	            }
	        } else {
	            console.warn(`📌 [Worker WebSocket] 해당 주문 ID(${orderId})를 찾을 수 없음 (UI 미반영)`);
	        }
	    });
	}
	
	// ✅ WebSocket 연결 실행
	connectWebSocket();

    
 	// ✅ 전체 선택 체크박스 기능 (수정됨)
    function toggleSelectAll() {
        let isChecked = document.getElementById("selectAllCheckbox").checked;
        document.querySelectorAll(".order-checkbox").forEach(checkbox => {
            checkbox.checked = isChecked;
        });
    }

 	// ✅ 개별 체크박스 해제 시 전체 선택 체크박스 상태 업데이트 (수정됨)
    function updateSelectAllCheckbox() {
        let total = document.querySelectorAll(".order-checkbox").length;
        let checked = document.querySelectorAll(".order-checkbox:checked").length;
        document.getElementById("selectAllCheckbox").checked = total === checked;
    }

    // ✅ UTC → KST 변환 함수
    function convertUtcToKst(utcTime) {
        if (!utcTime) return '-';
        let orderDate = new Date(Date.parse(utcTime));
        orderDate.setHours(orderDate.getHours());
        return orderDate.toTimeString().split(" ")[0];
    }

    // ✅ 페이지 로드 시 자동 실행
    document.addEventListener("DOMContentLoaded", function () {
        console.log("📌 Worker 페이지 DOM 로드 완료, 주문 목록 로드 시작");
        loadWorkerOrders();
        connectWebSocket();
    });
    
 // ✅ 페이지네이션 업데이트
		function updatePagination() {
		    const paginationContainer = document.getElementById("pageNumbers");
		    paginationContainer.innerHTML = "";
		
		    let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
		    let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
		
		    if (endPage - startPage + 1 < maxVisiblePages) {
		        startPage = Math.max(1, endPage - maxVisiblePages + 1);
		    }
		
		    // 이전 버튼 활성화 여부 설정
		    document.getElementById("prevGroup").disabled = currentPage === 1;
		    document.getElementById("nextGroup").disabled = currentPage === totalPages;
		
		    for (let i = startPage; i <= endPage; i++) {
		        let pageButton = document.createElement("button");
		        pageButton.innerText = i;
		        pageButton.classList.add("px-4", "py-2", "rounded-lg", "transition");
		
		        if (i === currentPage) {
		            pageButton.classList.add("bg-blue-500", "text-white");
		        } else {
		            pageButton.classList.add("bg-gray-200", "text-gray-700", "hover:bg-gray-300");
		        }
		
		        pageButton.addEventListener("click", function () {
		            if (currentPage !== i) {
		                currentPage = i;
		                loadWorkerOrders(currentPage);
		            }
		        });
		
		        paginationContainer.appendChild(pageButton);
		    }
		}

		// ✅ 주문 목록 가져오기 (페이지네이션 적용)
		function loadWorkerOrders(page = 1) {
		    fetch(`/admin/progress/data?page=${page}`)
		        .then(response => response.json())
		        .then(data => {
		            console.log("📌 Worker 페이지 주문 목록 응답:", data);

		            let tableBody = document.getElementById("workerOrderTableBody");
		            tableBody.innerHTML = "";

		            if (!data.progressList || data.progressList.length === 0) {
		                tableBody.innerHTML = "<tr><td colspan='7' class='p-4 text-center text-gray-500'>❌ 데이터가 없습니다.</td></tr>";
		                return;
		            }

		            data.progressList.forEach(order => {
		                let orderTime = convertUtcToKst(order.orderTime);
		                let row = `<tr class="hover:bg-gray-100 transition">
		                    <td class="p-3 border border-gray-300">
		                        <input type="checkbox" class="order-checkbox cursor-pointer" data-id="${order.orderId}" />
		                    </td>
		                    <td class="p-3 border border-gray-300">${order.orderId}</td>
		                    <td class="p-3 border border-gray-300">${order.productName}</td>
		                    <td class="p-3 border border-gray-300">${order.productCategory}</td>
		                    <td class="p-3 border border-gray-300">${orderTime}</td>
		                    <td class="p-3 border border-gray-300">
		                        ${order.boxState === 0 ? '미검사' : order.boxState === 1 ? '정상' : '파손'}
		                    </td>
		                    <td class="p-3 border border-gray-300 progress-state">
		                        ${order.progressState === 0 ? '물품 대기' : order.progressState === 1 ? '포장 완료' : '적재 완료'}
		                    </td>
		                </tr>`;
		                tableBody.innerHTML += row;
		            });

		            // ✅ 이벤트 리스너 재등록 (수정됨)
		            document.getElementById("selectAllCheckbox").addEventListener("change", toggleSelectAll);
		            document.querySelectorAll(".order-checkbox").forEach(checkbox => {
		                checkbox.addEventListener("change", updateSelectAllCheckbox);
		            });

		            totalPages = data.totalPages || 1;
		            updatePagination();
		        })
		        .catch(error => console.error("📌 Worker 페이지 주문 목록 로딩 실패:", error));
		}

		// ✅ 페이지 로드 시 자동 실행
		document.addEventListener("DOMContentLoaded", function () {
		    console.log("📌 Worker 페이지 DOM 로드 완료, 주문 목록 로드 시작");
		    loadWorkerOrders();
		});
		</script>
		<style>
    .table-container { max-height: 500px; overflow-y: auto; margin-top: 10px; }
    .order-table { width: 100%; border-collapse: collapse; }
    .order-table th, .order-table td { padding: 10px; border: 1px solid #ddd; text-align: center; }
    .pagination { display: flex; justify-content: center; margin-top: 10px; }
    .pagination button { padding: 5px 10px; margin: 2px; border: none; background: #eee; cursor: pointer; }
    .pagination .active { background: #6200ea; color: white; }
    
    /* 테이블 컨테이너 */
    .table-container {
        width: 100%;
        max-height: 500px;
        overflow-y: auto;
        overflow-x: auto;
        margin-top: 10px;
    }

    /* 테이블 */
    .progress-table {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed; /* 열 너비 고정 */
    }

    /* 테이블 헤더 */
    .progress-table th {
        background: #f4f4f4;
        padding: 12px;
        border: 1px solid #ddd;
        text-align: center;
        font-weight: bold;
    }

    /* 테이블 본문 */
    .progress-table td {
        padding: 10px;
        border: 1px solid #ddd;
        text-align: center;
        white-space: nowrap; /* 텍스트 줄 바꿈 방지 */
        overflow: hidden;
        text-overflow: ellipsis; /* 너무 길면 ... 처리 */
    }

    /* 각 열 크기 고정 */
    .progress-table th:nth-child(1),
    .progress-table td:nth-child(1) {
        width: 15%; /* 주문번호 */
    }

    .progress-table th:nth-child(2),
    .progress-table td:nth-child(2) {
        width: 20%; /* 상품명 */
    }

    .progress-table th:nth-child(3),
    .progress-table td:nth-child(3) {
        width: 10%; /* 카테고리 */
    }

    .progress-table th:nth-child(4),
    .progress-table td:nth-child(4) {
        width: 15%; /* 주문 시간 */
    }

    .progress-table th:nth-child(5),
    .progress-table td:nth-child(5) {
        width: 10%; /* 배송지 */
    }

    .progress-table th:nth-child(6),
    .progress-table td:nth-child(6) {
        width: 10%; /* 팔렛트 ID */
    }

    .progress-table th:nth-child(7),
    .progress-table td:nth-child(7) {
        width: 10%; /* 박스 상태 */
    }

    .progress-table th:nth-child(8),
    .progress-table td:nth-child(8) {
        width: 10%; /* 진행 상태 */
    }

    /* 페이지네이션 스타일 */
    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 10px;
    }

    .pagination button {
        padding: 8px 12px;
        margin: 2px;
        border: none;
        background: #eee;
        cursor: pointer;
        border-radius: 4px;
    }

    .pagination .active {
        background: #6200ea;
        color: white;
    }
</style>
		</html>
