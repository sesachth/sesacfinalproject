<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="~{/thymeleaf/html/common/default_layout}">

<head>
    <th:block layout:fragment="css">
        <link rel="stylesheet" th:href="@{/css/admin/admin.css}" />
        <link rel="stylesheet" th:href="@{/css/worker/worker_smartpackaging.css}" />
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
        <script th:src="@{/js/worker/worker_smartpackaging.js}"></script>
    </th:block>
</head>

<th:block layout:fragment="wrapper">
    <div class="outside-container">
        <div class="main-container">
            <div class="current-product-box">
                <div class="current-product-text">í˜„ì¬ ë¬¼í’ˆ</div>
            </div>
            <!-- í¬ì¥í•´ì•¼í•˜ëŠ” ë¬¼í’ˆ ì •ë³´ ê³µê°œì°½ -->
            <div class="product-container">
                <!-- í˜„ì¬ ë¬¼í’ˆ -->
                <div class="current-section">
                    <div class="current-product-orderid"></div>
                    <div class="current-product-name"></div>
                </div>
            </div>
            
            <!-- ë°•ìŠ¤ ì •ë³´, í¬ì¥ì™„ë£Œ ë²„íŠ¼, ì™„ì¶©ì¬ í•„ìš” ì—¬ë¶€ -->
            <div class="packaging-part">
                <!-- ë°•ìŠ¤ ì •ë³´ -->
                <div class="packaging-box">
                    <img th:src="@{/images/worker/ë¬´ì§€ íƒë°°ë°•ìŠ¤.jpg}" alt="ë°•ìŠ¤ ì´ë¯¸ì§€" class="packaging-box-image">
                    <div class="packaging-box-text" id="currentBoxSize"></div>
                </div>

                <!-- í¬ì¥ì™„ë£Œ ë²„íŠ¼ -->
                <div class="packaging-completion">
                    <button class="packaging-button" onclick="completeSelectedPackaging(this)">
                        í¬ì¥ì™„ë£Œ
                    </button>
                </div>

                <!-- ì™„ì¶©ì¬ í•„ìš” ì—¬ë¶€ -->
                <div class="fender-info">
                    <img th:src="@{/images/worker/ì¢…ì´ ì™„ì¶©ì¬.jpg}" alt="ì¢…ì´ ì™„ì¶©ì¬" class="fender-image">
                    <!-- <div class="${is_fragile ? 'fender-O' : 'fender-X'}" class="fender-OX"></div>-->
                    <div class="fender-X"></div>
                    <div class="fender-O"></div>
                </div>
            </div>
            <!-- ë¬¼í’ˆ í…Œì´ë¸” / íŒ¨í‚¤ì§•í•  ë¬¼í’ˆ í…Œì´ë¸” 5ê°œì”©-->
            <div class="table-container">
                <div class="table-title">
                    <h3>ğŸ“¦ ë¬¼í’ˆ ëª©ë¡</h3>
                </div>
                <table class="packaging-table">
                    <colgroup>
                        <col style="width: 10%">   <!-- palletID -->
                        <col style="width: 10%">   <!-- packaging_seq -->
                        <col style="width: 20%">   <!-- orderID -->
                        <col style="width: 35%">   <!-- product name -->
                        <col style="width: 25%">   <!-- category -->
                    </colgroup>
                    <thead>
                        <tr>
                            <th class="align-center">Pallet ID</th>
                            <th class="align-center">Sequence</th>
                            <th class="align-center">Order ID</th>
                            <th class="align-left">Product Name</th>
                            <th class="align-left">Category</th>
                        </tr>
                    </thead>
                    <tbody id="workerOrderTableBody">
                        <!-- ë™ì ìœ¼ë¡œ ìƒì„±ë˜ëŠ” í–‰ë“¤ -->
                    </tbody>
                </table>
            </div>  
        </div>
    </div>
</th:block>

<!-- <script>
let currentPage = 1;
const rowsPerPage = 10;
const pageGroupSize = 10;
let totalPages = 1;
let progressData = [];

window.onload = () => {
    loadProgress();
    connectWebSocket();
};

function loadWorkerOrders(page = 1) {
    fetch(`/admin/progress/data?page=${page}`)
        .then(response => response.json())
        .then(data => {
            console.log("ğŸ“Œ Worker í˜ì´ì§€ ì£¼ë¬¸ ëª©ë¡ ì‘ë‹µ:", data); // API ì‘ë‹µ í™•ì¸

            let tableBody = document.getElementById("workerOrderTableBody");
            tableBody.innerHTML = "";

            if (!data.progressList || data.progressList.length === 0) {
                tableBody.innerHTML = "<tr><td colspan='6' class='p-4 text-center text-gray-500'>âŒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
                return;
            }

            data.progressList.forEach(order => {
                let boxSpecValue = (order.boxSpec === null || order.boxSpec === undefined || order.boxSpec === 0) ? '-' : order.boxSpec;
                let isFragileValue = (order.isFragile === true || order.isFragile === 1) ? 'O' : 'X';  // âœ… ìˆ˜ì •

                let row = `<tr class="hover:bg-gray-100 transition">
                    <td class="p-3 border border-gray-300">${order.orderId}</td>
                    <td class="p-3 border border-gray-300">${order.productName}</td>
                    <td class="p-3 border border-gray-300">${order.productCategory}</td>
                    <td class="p-3 border border-gray-300">${boxSpecValue}</td>
                    <td class="p-3 border border-gray-300">${isFragileValue}</td>
                    <td class="p-3 border border-gray-300 progress-state">
                        ${order.progressState === 0 
                            ? `<button class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded"
                                       onclick="completePackaging(${order.orderId}, this)">
                                   ë¬¼í’ˆ ëŒ€ê¸°
                               </button>` 
                            : (order.progressState === 1 ? '<span class="text-green-600 font-bold">âœ… í¬ì¥ ì™„ë£Œ</span>' 
                            : '<span class="text-gray-600">ğŸ“¦ ì ì¬ ì™„ë£Œ</span>')}
                    </td>
                </tr>`;

                tableBody.innerHTML += row;
            });


            // âœ… í˜ì´ì§€ ìˆ˜ ì—…ë°ì´íŠ¸
            totalPages = data.totalPages || 1;
            currentPage = page;
            updatePagination();
        })
        .catch(error => console.error("ğŸ“Œ Worker í˜ì´ì§€ ì£¼ë¬¸ ëª©ë¡ ë¡œë”© ì‹¤íŒ¨:", error));
}

// âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
document.addEventListener("DOMContentLoaded", function () {
    console.log("ğŸ“Œ Worker í˜ì´ì§€ DOM ë¡œë“œ ì™„ë£Œ, ì£¼ë¬¸ ëª©ë¡ ë¡œë“œ ì‹œì‘");
    loadWorkerOrders();
});

    // âœ… WebSocket ì—°ê²° ì„¤ì •
    function connectWebSocket() {
        let socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function(frame) {
            console.log('ğŸ“Œ Worker í˜ì´ì§€ WebSocket ì—°ê²°ë¨:', frame);

            // âœ… ì§„í–‰ ìƒíƒœ ë³€ê²½ êµ¬ë… (Worker & Admin ë™ê¸°í™”)
            stompClient.subscribe('/topic/updateStatus', function(message) {
                let updatedProgress = JSON.parse(message.body);
                console.log("ğŸ“Œ Workerê°€ ë°›ì€ WebSocket ë©”ì‹œì§€:", updatedProgress);
                updateProgressState(updatedProgress.orderIds, updatedProgress.progressState);
            });
        }, function(error) {
            console.error('ğŸ“Œ WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
            setTimeout(connectWebSocket, 5000);
        });
    }
    
 // âœ… í˜ì´ì§€ë„¤ì´ì…˜ ì—…ë°ì´íŠ¸
    function updatePagination() {
        const paginationContainer = document.getElementById("pageNumbers");
        paginationContainer.innerHTML = ""; // ê¸°ì¡´ ë²„íŠ¼ ì´ˆê¸°í™”

        if (totalPages <= 1) {
            return; // í•œ í˜ì´ì§€ë§Œ ìˆìœ¼ë©´ í˜ì´ì§€ë„¤ì´ì…˜ ìˆ¨ê¹€
        }

        let startPage = Math.max(1, currentPage - Math.floor(pageGroupSize / 2));
        let endPage = Math.min(totalPages, startPage + pageGroupSize - 1);

        if (endPage - startPage + 1 < pageGroupSize) {
            startPage = Math.max(1, endPage - pageGroupSize + 1);
        }

        // âœ… ì´ì „ ë²„íŠ¼ ì¶”ê°€ (ë§¨ ì²˜ìŒìœ¼ë¡œ ì´ë™)
        if (currentPage > 1) {
            let prevButton = document.createElement("button");
            prevButton.innerHTML = "Â«";
            prevButton.classList.add("px-4", "py-2", "mx-1", "rounded-lg", "transition", "bg-gray-300", "hover:bg-gray-400");
            prevButton.onclick = () => loadWorkerOrders(1);
            paginationContainer.appendChild(prevButton);
        }

        // âœ… í˜ì´ì§€ ìˆ«ì ë²„íŠ¼ ìƒì„±
        for (let i = startPage; i <= endPage; i++) {
            let pageButton = document.createElement("button");
            pageButton.innerText = i;
            pageButton.classList.add("px-4", "py-2", "mx-1", "rounded-lg", "transition");

            if (i === currentPage) {
                pageButton.classList.add("bg-blue-500", "text-white", "font-bold");
            } else {
                pageButton.classList.add("bg-gray-200", "text-gray-700", "hover:bg-gray-300");
                pageButton.onclick = function () {
                    loadWorkerOrders(i);
                };
            }
            paginationContainer.appendChild(pageButton);
        }

        // âœ… ë‹¤ìŒ ë²„íŠ¼ ì¶”ê°€ (ë§¨ ëìœ¼ë¡œ ì´ë™)
        if (currentPage < totalPages) {
            let nextButton = document.createElement("button");
            nextButton.innerHTML = "Â»";
            nextButton.classList.add("px-4", "py-2", "mx-1", "rounded-lg", "transition", "bg-gray-300", "hover:bg-gray-400");
            nextButton.onclick = () => loadWorkerOrders(totalPages);
            paginationContainer.appendChild(nextButton);
        }
    }


    // âœ… ê°œë³„ í¬ì¥ ì™„ë£Œ ë²„íŠ¼ í´ë¦­ ì‹œ WebSocket ë©”ì‹œì§€ ì „ì†¡
    function completePackaging(orderId, buttonElement) {
        if (confirm("í¬ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆê¹Œ?")) {
            let imageNumber = Math.floor(Math.random() * 100) + 1; // 1~100 ëœë¤ ì´ë¯¸ì§€

            let message = {
                orderIds: [orderId],
                progressState: 1, // í¬ì¥ ì™„ë£Œ
                imageNumber: imageNumber
            };

            console.log("ğŸ“Œ WebSocket ì „ì†¡ ë©”ì‹œì§€ (Worker â†’ Server):", message);

            // âœ… WebSocketì„ í†µí•´ ìƒíƒœ ë³€ê²½ ìš”ì²­ ì „ì†¡
            stompClient.send("/app/updateStatus", {}, JSON.stringify(message));
            stompClient.send("/topic/updateStatus", {}, JSON.stringify(message));

            // âœ… UI ì—…ë°ì´íŠ¸ (ë²„íŠ¼ì„ 'í¬ì¥ ì™„ë£Œ'ë¡œ ë³€ê²½ ë° ë¹„í™œì„±í™”)
            buttonElement.outerHTML = '<span class="text-green-600 font-bold">âœ… í¬ì¥ ì™„ë£Œ</span>';

            alert("âœ… í¬ì¥ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    }

    // âœ… UTC â†’ KST ë³€í™˜ í•¨ìˆ˜
    function convertUtcToKst(utcTime) {
        if (!utcTime) return '-';
        let orderDate = new Date(Date.parse(utcTime));
        orderDate.setHours(orderDate.getHours());
        return orderDate.toTimeString().split(" ")[0];
    }

    // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì‹¤í–‰
    document.addEventListener("DOMContentLoaded", function () {
        console.log("ğŸ“Œ Worker í˜ì´ì§€ DOM ë¡œë“œ ì™„ë£Œ, ì£¼ë¬¸ ëª©ë¡ ë¡œë“œ ì‹œì‘");
        loadWorkerOrders();
        connectWebSocket();
    });
</script> -->

</html>
