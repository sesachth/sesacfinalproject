<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="~{/thymeleaf/html/common/default_layout}">

<th:block layout:fragment="css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" th:href="@{/css/admin/admin.css}">
    <link rel="stylesheet" th:href="@{/css/worker/worker_smartpackaging.css}">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs/lib/stomp.min.js"></script>
</th:block>

<th:block layout:fragment="wrapper">
    <div class="outside-container">
        <div class="main-container">
            <div class="container mt-5">
                <div class="content-wrapper">
                    <div class="row w-100">
                        <!-- 재포장 완료 문구 -->
                        <div class="col-12 text-center mb-4">
                            <h2>재포장 완료</h2>
                        </div>

                        <!-- 박스 정보 -->
                        <div class="col">
                            <h3 class="text-center">📦 박스 정보</h3>
                            <div id="box-info" class="custom-box p-3 border rounded">
                                <p>박스 정보를 불러오는 중...</p>
                            </div>
                        </div>

                        <!-- 완충재 필요 여부 -->
                        <div class="col">
                            <h3 class="text-center">🛠 완충재 필요 여부</h3>
                            <div id="cushion-info" class="custom-box p-3 border rounded">
                                <p>완충재 정보를 불러오는 중...</p>
                            </div>
                        </div>

                        <!-- 재포장 완료 버튼 -->
                        <div class="col-12 text-center mt-4">
                            <button class="btn btn-success" onclick="completePackaging()">포장 완료</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</th:block>

<script>
	//WebSocket 연결
	var socket = new SockJS('/ws');
	var stompClient = Stomp.over(socket);
	
	stompClient.connect({}, function(frame) {
	    console.log('WebSocket 연결됨: ' + frame);
	
	    // 진행 상태 변경을 실시간으로 수신
	    stompClient.subscribe('/topic/progress', function(message) {
	        var data = JSON.parse(message.body);
	        updateProgressState(data.orderId, data.progressState);
	    });
	});
	
	// 진행 상태 업데이트
	function updateProgressState(orderId, progressState) {
	    var row = document.querySelector(`tr[data-order-id='${orderId}']`);
	    if (row) {
	        row.querySelector(".progress-state").innerText = progressState;
	    }
	}
	
	// 포장 완료 버튼 클릭 이벤트
	function completePackaging(orderId) {
	    var message = {
	        orderId: orderId,
	        progressState: "포장 완료"
	    };
	
	    stompClient.send("/app/updateStatus", {}, JSON.stringify(message));
	    alert("포장이 완료되었습니다.");
	}

</script>

</html>
